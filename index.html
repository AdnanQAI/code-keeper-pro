<!DOCTYPE html>
<html lang="en" dir="ltr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="format-detection" content="telephone=no">
    <title>Code & Files Keeper Pro</title>
    
    <!-- PWA Meta Tags -->
    <meta name="application-name" content="Code Keeper Pro">
    <meta name="apple-mobile-web-app-title" content="CodeKeeper">
    <meta name="description" content="Advanced code and files management with export capabilities">
    <meta name="theme-color" content="#4CAF50">
    <meta name="msapplication-TileColor" content="#4CAF50">
    
    <!-- PWA Manifest -->
    <link rel="manifest" href="manifest.json">
    
    <!-- Apple Touch Icons -->
    <link rel="apple-touch-icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 512 512'%3E%3Crect width='512' height='512' fill='%234CAF50'/%3E%3Cpath d='M128 96h256v320H128z' fill='%23fff'/%3E%3Cpath d='M160 160h192v32H160zm0 64h192v32H160zm0 64h128v32H160z' fill='%234CAF50'/%3E%3C/svg%3E">
    
    <!-- iOS Splash Screens -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    
    <!-- PDF Export Library -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    
    <!-- Excel Export Library -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    
    <!-- Word Export Library -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/docx/7.1.0/docx.js"></script>
    
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #2c3e50 0%, #3498db 100%);
            min-height: 100vh;
            padding: 20px;
            margin: 0;
        }
        /* PWA Specific Styles */
        @media (display-mode: standalone) {
            body {
                padding-top: env(safe-area-inset-top);
                padding-bottom: env(safe-area-inset-bottom);
            }
        }
        
        /* iOS Safari Specific */
        @supports (-webkit-touch-callout: none) {
            .container {
                padding-bottom: env(safe-area-inset-bottom, 20px);
            }
        }
        
        /* Touch-friendly improvements */
        button, .btn {
            min-height: 44px;
            touch-action: manipulation;
        }
        
        /* Prevent zoom on inputs */
        input[type="text"], textarea {
            font-size: 16px;
        }
        
        /* Install button animation */
        @keyframes slideInUp {
            from {
                transform: translateY(100px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }
        .container {
            max-width: 1000px;
            margin: 0 auto;
            background: #fff;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            padding: 30px;
        }
        .header {
            text-align: center;
            margin-bottom: 30px;
        }
        .header h1 {
            color: #2c3e50;
            font-size: 2.2em;
            margin-bottom: 10px;
        }
        .info-box {
            background: #e8f4fd;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            border-left: 4px solid #3498db;
            font-size: 14px;
            color: #2c3e50;
        }
        .stats-box {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 10px;
            margin: 20px 0;
            border-left: 4px solid #27ae60;
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
        }
        .stat-item {
            font-size: 14px;
            color: #2c3e50;
        }
        .add-form {
            background: #f8f9fa;
            padding: 25px;
            border-radius: 12px;
            margin-bottom: 30px;
            border: 2px dashed #3498db;
        }
        .form-group {
            margin-bottom: 20px;
        }
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            color: #2c3e50;
        }
        .form-group input,
        .form-group textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 15px;
            box-sizing: border-box;
        }
        .form-group input:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #3498db;
        }
        .form-group textarea {
            height: 120px;
            resize: vertical;
            font-family: 'Courier New', monospace;
            direction: ltr;
            text-align: left;
        }
        .file-upload {
            border: 2px dashed #bdc3c7;
            border-radius: 10px;
            padding: 25px;
            text-align: center;
            cursor: pointer;
            background: #fff;
            transition: all 0.3s;
        }
        .file-upload:hover {
            border-color: #3498db;
            background: #f0f8ff;
        }
        .file-upload.dragover {
            border-color: #3498db;
            background: #e8f4fd;
        }
        .btn {
            background: linear-gradient(135deg, #3498db 0%, #2c3e50 100%);
            color: white;
            padding: 12px 30px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            cursor: pointer;
            transition: transform 0.3s;
        }
        .btn:hover {
            transform: translateY(-2px);
        }
        
        .export-controls {
            background: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        
        .selection-controls h4 {
            color: #2c3e50;
            margin-bottom: 15px;
            text-align: center;
        }
        
        .selection-options {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        
        .selection-option {
            display: flex;
            align-items: center;
            cursor: pointer;
            padding: 10px 15px;
            border: 2px solid #ddd;
            border-radius: 8px;
            transition: all 0.3s;
            background: #f8f9fa;
        }
        
        .selection-option:hover {
            border-color: #3498db;
            background: #e8f4fd;
        }
        
        .selection-option input[type="radio"] {
            margin-right: 8px;
        }
        
        .selection-option input[type="radio"]:checked + span {
            color: #3498db;
            font-weight: bold;
        }
        
        .selected-items-section, .single-item-section {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin-top: 15px;
        }
        
        .items-checklist {
            max-height: 200px;
            overflow-y: auto;
            border: 1px solid #ddd;
            border-radius: 5px;
            padding: 10px;
            background: white;
            margin-bottom: 15px;
        }
        
        .checklist-item {
            display: flex;
            align-items: center;
            padding: 8px;
            border-bottom: 1px solid #eee;
            transition: background 0.3s;
        }
        
        .checklist-item:hover {
            background: #f0f8ff;
        }
        
        .checklist-item:last-child {
            border-bottom: none;
        }
        
        .checklist-item input[type="checkbox"] {
            margin-right: 10px;
        }
        
        .checklist-item-info {
            flex: 1;
        }
        
        .checklist-item-title {
            font-weight: bold;
            color: #2c3e50;
        }
        
        .checklist-item-meta {
            font-size: 12px;
            color: #7f8c8d;
        }
        
        .selection-actions {
            display: flex;
            align-items: center;
            gap: 10px;
            flex-wrap: wrap;
        }
        
        .selection-btn {
            background: #3498db;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.3s;
        }
        
        .selection-btn:hover {
            background: #2980b9;
            transform: translateY(-2px);
        }
        
        .selected-count {
            margin-left: auto;
            font-weight: bold;
            color: #27ae60;
            padding: 5px 10px;
            background: #e8f5e8;
            border-radius: 15px;
            font-size: 12px;
        }
        
        .export-settings {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        
        .setting-option {
            display: flex;
            align-items: center;
            cursor: pointer;
            padding: 8px;
            border-radius: 5px;
            transition: background 0.3s;
        }
        
        .setting-option:hover {
            background: #f0f8ff;
        }
        
        .setting-option input[type="checkbox"] {
            margin-right: 8px;
        }
        
        .setting-option span {
            font-size: 14px;
            color: #2c3e50;
        }
        
        .content-mode-selection {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-bottom: 25px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 10px;
        }
        
        .mode-option {
            display: flex;
            align-items: center;
            cursor: pointer;
            padding: 10px 15px;
            border: 2px solid #ddd;
            border-radius: 8px;
            transition: all 0.3s;
            background: white;
        }
        
        .mode-option:hover {
            border-color: #3498db;
            background: #e8f4fd;
        }
        
        .mode-option input[type="radio"] {
            margin-left: 8px;
        }
        
        .mode-option input[type="radio"]:checked + span {
            color: #3498db;
            font-weight: bold;
        }
        
        .content-form {
            transition: all 0.3s;
        }
        
        .separator-options {
            display: flex;
            flex-direction: column;
            gap: 10px;
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
        }
        
        .separator-option {
            display: flex;
            align-items: center;
            cursor: pointer;
            padding: 8px;
            border-radius: 5px;
            transition: background 0.3s;
        }
        
        .separator-option:hover {
            background: #e8f4fd;
        }
        
        .separator-option input[type="radio"] {
            margin-left: 8px;
        }
        
        .separator-option input[type="text"] {
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 5px 8px;
            font-size: 14px;
        }
        
        .multiple-actions {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-top: 20px;
        }
        
        .preview-btn {
            background: linear-gradient(135deg, #f39c12 0%, #d68910 100%);
        }
        
        .multiple-preview {
            margin-top: 20px;
            border: 2px solid #3498db;
            border-radius: 10px;
            padding: 20px;
            background: #f8f9fa;
            max-height: 400px;
            overflow-y: auto;
        }
        
        .preview-item {
            background: white;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
        }
        
        .preview-title {
            font-weight: bold;
            color: #2c3e50;
            margin-bottom: 10px;
            font-size: 16px;
        }
        
        .preview-content {
            background: #2c3e50;
            color: #ecf0f1;
            padding: 10px;
            border-radius: 5px;
            font-family: monospace;
            white-space: pre-wrap;
            max-height: 150px;
            overflow-y: auto;
        }

        /* Modern Export Dashboard Styles - Compact Version */
        .export-dashboard {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 12px;
            padding: 15px;
            margin: 20px 0;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }

        /* Unified Dashboard Styles */
        /* Compact Management Box */
        .unified-dashboard {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 8px;
            padding: 10px;
            margin: 15px auto;
            max-width: 600px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .dashboard-header {
            text-align: center;
            margin-bottom: 8px;
            color: white;
        }

        .dashboard-header h3 {
            font-size: 14px;
            margin: 0 0 3px 0;
            text-shadow: 0 1px 2px rgba(0,0,0,0.3);
        }

        .dashboard-header p {
            opacity: 0.9;
            font-size: 10px;
            margin: 0;
        }

        .dashboard-grid {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 8px;
        }

        .dashboard-panel {
            background: rgba(255,255,255,0.95);
            border-radius: 6px;
            padding: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .panel-header {
            text-align: center;
            margin-bottom: 6px;
            padding-bottom: 4px;
            border-bottom: 1px solid #f0f0f0;
        }

        .panel-header h4 {
            color: #2c3e50;
            font-size: 11px;
            margin: 0;
        }

        .action-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 3px;
        }

        .action-btn {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 4px;
            padding: 4px;
            font-size: 9px;
            cursor: pointer;
            transition: all 0.2s;
            text-align: center;
            min-height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .action-btn:hover {
            background: #e9ecef;
            transform: translateY(-1px);
        }

        .import-btn:hover { border-color: #17a2b8; color: #17a2b8; }
        .view-btn:hover { border-color: #28a745; color: #28a745; }
        .search-btn:hover { border-color: #ffc107; color: #e0a800; }
        .stats-btn:hover { border-color: #6f42c1; color: #6f42c1; }

        .export-modes {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 2px;
            margin-bottom: 4px;
        }

        .mode-btn {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 4px;
            padding: 3px;
            font-size: 8px;
            cursor: pointer;
            transition: all 0.2s;
            text-align: center;
            min-height: 18px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .mode-btn.active {
            background: #3498db;
            color: white;
            border-color: #2980b9;
        }

        .mode-btn:hover {
            transform: translateY(-1px);
        }

        .export-formats {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 2px;
        }

        .format-btn {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 4px;
            padding: 4px;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.2s;
            min-height: 22px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .format-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }

        .pdf-btn:hover { border-color: #e74c3c; }
        .word-btn:hover { border-color: #2980b9; }
        .excel-btn:hover { border-color: #27ae60; }
        .note-btn:hover { border-color: #f39c12; }
        .json-btn:hover { border-color: #8e44ad; }

        .compact-select {
            width: 100%;
            padding: 3px;
            border: 1px solid #e9ecef;
            border-radius: 3px;
            font-size: 9px;
            margin-top: 4px;
        }

        .settings-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 2px;
        }

        .setting-toggle {
            display: flex;
            align-items: center;
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 4px;
            padding: 3px;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 9px;
        }

        .setting-toggle input[type="checkbox"] {
            margin-left: 3px;
            transform: scale(0.7);
        }

        .setting-toggle:hover {
            background: #e9ecef;
            border-color: #3498db;
        }

        /* Ultra Compact Mobile Design */
        @media (max-width: 768px) {
            .unified-dashboard {
                max-width: 100%;
                margin: 10px;
                padding: 8px;
            }
            
            .dashboard-grid {
                grid-template-columns: 1fr;
                gap: 6px;
            }
            
            .action-grid {
                grid-template-columns: repeat(4, 1fr);
                gap: 2px;
            }
            
            .export-modes {
                grid-template-columns: 1fr 1fr 1fr;
            }
            
            .export-formats {
                grid-template-columns: repeat(5, 1fr);
                gap: 1px;
            }
            
            .settings-grid {
                grid-template-columns: repeat(4, 1fr);
                gap: 2px;
            }
            
            .action-btn, .mode-btn, .setting-toggle {
                font-size: 8px;
                padding: 2px;
                min-height: 16px;
            }
            
            .format-btn {
                font-size: 10px;
                padding: 2px;
                min-height: 18px;
            }
            
            .dashboard-header h3 {
                font-size: 12px;
            }
            
            .dashboard-header p {
                font-size: 8px;
            }
            
            .panel-header h4 {
                font-size: 10px;
            }
        }

        @media (max-width: 480px) {
            .unified-dashboard {
                padding: 6px;
            }
            
            .action-grid {
                grid-template-columns: 1fr 1fr;
            }
            
            .settings-grid {
                grid-template-columns: 1fr 1fr;
            }
            
            .export-formats {
                grid-template-columns: repeat(3, 1fr);
            }
        }

        .export-header {
            text-align: center;
            margin-bottom: 15px;
            color: white;
        }

        .export-header h3 {
            font-size: 20px;
            margin-bottom: 5px;
            text-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }

        .export-header p {
            opacity: 0.9;
            font-size: 13px;
        }

        .export-main-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            margin-bottom: 12px;
        }

        .export-panel {
            background: rgba(255,255,255,0.95);
            border-radius: 10px;
            padding: 12px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            backdrop-filter: blur(10px);
        }

        .panel-header {
            text-align: center;
            margin-bottom: 12px;
            padding-bottom: 8px;
            border-bottom: 1px solid #f0f0f0;
        }

        .panel-header h4 {
            color: #2c3e50;
            font-size: 14px;
            margin: 0;
        }

        /* Mode Cards - Compact */
        .export-mode-cards {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 6px;
            margin-bottom: 12px;
        }

        .mode-card {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            padding: 8px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .mode-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 12px rgba(0,0,0,0.15);
        }

        .mode-card.active {
            background: linear-gradient(135deg, #3498db 0%, #2980b9 100%);
            color: white;
            border-color: #2980b9;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(52, 152, 219, 0.3);
        }

        .mode-icon {
            font-size: 16px;
            margin-bottom: 4px;
        }

        .mode-title {
            font-weight: bold;
            font-size: 11px;
            margin-bottom: 2px;
        }

        .mode-count {
            font-size: 10px;
            opacity: 0.8;
        }

        /* Selection Details - Compact */
        .selection-details {
            min-height: 120px;
        }

        .mode-details {
            display: none;
        }

        .mode-details.active {
            display: block;
        }

        .selection-summary {
            text-align: center;
            padding: 20px 10px;
            color: #7f8c8d;
        }

        .items-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 6px;
            max-height: 150px;
            overflow-y: auto;
            margin-bottom: 10px;
            padding: 8px;
            border: 1px solid #e9ecef;
            border-radius: 6px;
        }

        .item-card {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 6px;
            padding: 8px;
            transition: all 0.3s;
            cursor: pointer;
        }

        .item-card:hover {
            background: #e9ecef;
        }

        .item-card.selected {
            background: #d4edda;
            border-color: #27ae60;
        }

        .item-card-title {
            font-weight: bold;
            color: #2c3e50;
            margin-bottom: 3px;
            font-size: 12px;
        }

        .item-card-meta {
            font-size: 10px;
            color: #6c757d;
        }

        .selection-actions {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 6px;
        }

        .action-btn {
            border: none;
            border-radius: 6px;
            padding: 4px 8px;
            font-size: 10px;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: bold;
        }

        .action-btn.primary {
            background: #27ae60;
            color: white;
        }

        .action-btn.secondary {
            background: #e74c3c;
            color: white;
        }

        .action-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 3px 8px rgba(0,0,0,0.2);
        }

        .selection-counter {
            background: #3498db;
            color: white;
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 10px;
            font-weight: bold;
        }

        .modern-select {
            width: 100%;
            padding: 8px;
            border: 1px solid #e9ecef;
            border-radius: 6px;
            font-size: 12px;
            background: white;
            color: #2c3e50;
        }

        /* Format Cards - Compact */
        .format-cards {
            display: grid;
            gap: 8px;
        }

        .format-card {
            display: flex;
            align-items: center;
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            padding: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .format-card:hover {
            transform: translateX(3px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }

        .format-card.pdf-card:hover { border-color: #e74c3c; }
        .format-card.word-card:hover { border-color: #2980b9; }
        .format-card.excel-card:hover { border-color: #27ae60; }
        .format-card.note-card:hover { border-color: #f39c12; }
        .format-card.json-card:hover { border-color: #8e44ad; }

        .format-icon {
            font-size: 20px;
            margin-left: 8px;
        }

        .format-info {
            flex: 1;
        }

        .format-title {
            font-weight: bold;
            color: #2c3e50;
            font-size: 12px;
            margin-bottom: 2px;
        }

        .format-desc {
            color: #7f8c8d;
            font-size: 10px;
        }

        .format-action {
            background: #3498db;
            color: white;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 10px;
            font-weight: bold;
        }

        /* Settings Panel - Compact */
        .export-settings-panel {
            background: rgba(255,255,255,0.95);
            border-radius: 10px;
            padding: 12px;
            backdrop-filter: blur(10px);
        }

        .settings-header {
            text-align: center;
            margin-bottom: 12px;
            color: #2c3e50;
        }

        .settings-options {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 8px;
        }

        .setting-toggle {
            display: flex;
            align-items: center;
            background: #f8f9fa;
            border-radius: 8px;
            padding: 8px;
            cursor: pointer;
            transition: all 0.3s;
            border: 1px solid #e9ecef;
        }

        .setting-toggle:hover {
            background: #e9ecef;
            border-color: #3498db;
        }

        .toggle-slider {
            width: 32px;
            height: 18px;
            background: #ccc;
            border-radius: 15px;
            position: relative;
            margin-left: 8px;
            transition: all 0.3s;
        }

        .toggle-slider::before {
            content: '';
            position: absolute;
            width: 14px;
            height: 14px;
            background: white;
            border-radius: 50%;
            top: 2px;
            left: 2px;
            transition: all 0.3s;
        }

        .setting-toggle input[type="checkbox"] {
            display: none;
        }

        .setting-toggle input[type="checkbox"]:checked + .toggle-slider {
            background: #3498db;
        }

        .setting-toggle input[type="checkbox"]:checked + .toggle-slider::before {
            transform: translateX(14px);
        }

        .setting-info {
            flex: 1;
        }

        .setting-title {
            font-weight: bold;
            color: #2c3e50;
            margin-bottom: 2px;
            font-size: 11px;
        }

        .setting-desc {
            color: #7f8c8d;
            font-size: 9px;
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .export-main-container {
                grid-template-columns: 1fr;
            }
            
            .export-mode-cards {
                grid-template-columns: 1fr;
            }
            
            .items-grid {
                grid-template-columns: 1fr;
            }
            
            .settings-options {
                grid-template-columns: 1fr;
            }
        }
        
        .export-buttons {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin-top: 20px;
        }
        
        .export-group {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        
        .export-group h4 {
            color: #2c3e50;
            margin-bottom: 15px;
            text-align: center;
            font-size: 16px;
        }
        
        .export-btn {
            width: 100%;
            padding: 12px 15px;
            margin: 8px 0;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            text-align: center;
        }
        
        .pdf-btn {
            background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
            color: white;
        }
        
        .word-btn {
            background: linear-gradient(135deg, #2980b9 0%, #1f4e79 100%);
            color: white;
        }
        
        .excel-btn {
            background: linear-gradient(135deg, #27ae60 0%, #1e8449 100%);
            color: white;
        }
        
        .note-btn {
            background: linear-gradient(135deg, #f39c12 0%, #d68910 100%);
            color: white;
        }
        
        .json-btn {
            background: linear-gradient(135deg, #8e44ad 0%, #6c3483 100%);
            color: white;
        }
        
        .export-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(0,0,0,0.2);
        }
        
        .item-selector {
            width: 100%;
            padding: 10px;
            border: 2px solid #bdc3c7;
            border-radius: 5px;
            font-size: 14px;
            background: white;
        }
        
        .selected-export-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }
        
        .selected-export-buttons .export-btn {
            flex: 1;
            min-width: 80px;
            padding: 8px 10px;
            font-size: 12px;
        }
        
        @media (max-width: 768px) {
            .export-buttons {
                grid-template-columns: 1fr;
                gap: 20px;
            }
            
            .selected-export-buttons {
                flex-direction: column;
            }
            
            .selected-export-buttons .export-btn {
                width: 100%;
            }
        }
        .preview-container {
            margin-top: 15px;
        }
        .file-preview {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 10px;
            margin: 10px 0;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        .file-info {
            display: flex;
            align-items: center;
        }
        .file-icon {
            font-size: 24px;
            margin-right: 10px;
        }
        .file-details {
            display: flex;
            flex-direction: column;
        }
        .file-name {
            font-weight: bold;
            color: #2c3e50;
            font-size: 14px;
        }
        .file-size {
            color: #7f8c8d;
            font-size: 12px;
        }
        .remove-btn {
            background: #e74c3c;
            color: white;
            border: none;
            border-radius: 50%;
            width: 25px;
            height: 25px;
            cursor: pointer;
            font-weight: bold;
        }
        .image-preview {
            max-width: 150px;
            max-height: 100px;
            border-radius: 8px;
            margin: 5px;
            cursor: pointer;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        .search-box {
            width: 100%;
            padding: 15px;
            font-size: 16px;
            border: 2px solid #3498db;
            border-radius: 10px;
            margin-bottom: 20px;
            box-sizing: border-box;
        }
        .view-toggle {
            text-align: center;
            margin: 20px 0;
        }
        .view-toggle button {
            background: #95a5a6;
            color: white;
            border: none;
            padding: 10px 20px;
            margin: 0 5px;
            border-radius: 5px;
            cursor: pointer;
        }
        .view-toggle button.active {
            background: #3498db;
        }
        .codes-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        .code-card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            border: 1px solid #ecf0f1;
        }
        .code-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid #eee;
        }
        .code-title {
            font-size: 1.2em;
            font-weight: bold;
            color: #2c3e50;
        }
        .delete-btn {
            background: #e74c3c;
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 12px;
        }
        .code-content {
            margin-bottom: 15px;
        }
        .code-box {
            background: #2c3e50;
            color: #ecf0f1;
            padding: 15px;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            white-space: pre-wrap;
            word-break: break-all;
            position: relative;
            margin: 10px 0;
            max-height: 200px;
            overflow-y: auto;
            direction: ltr;
            text-align: left;
        }
        .copy-btn {
            position: absolute;
            top: 10px;
            right: 10px;
            background: #3498db;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 12px;
        }
        .files-section {
            margin-top: 15px;
        }
        .attached-files {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 10px;
        }
        .stats-info {
            font-size: 12px;
            color: #7f8c8d;
            margin-top: 10px;
            padding: 8px;
            background: #f8f9fa;
            border-radius: 5px;
        }
        .codes-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            background: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            display: none;
        }
        .codes-table th,
        .codes-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #eee;
        }
        .codes-table th {
            background: #3498db;
            color: white;
            font-weight: bold;
        }
        .codes-table tr:hover {
            background: #f8f9fa;
        }
        .action-btn {
            background: #3498db;
            color: white;
            border: none;
            padding: 5px 8px;
            border-radius: 3px;
            cursor: pointer;
            margin: 2px;
            font-size: 12px;
        }
        .edit-btn {
            background: #f39c12;
        }
        .del-btn {
            background: #e74c3c;
        }
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.9);
        }
        .modal-content {
            margin: auto;
            display: block;
            width: 90%;
            max-width: 700px;
            max-height: 90%;
            margin-top: 2%;
            border-radius: 10px;
        }
        .close {
            position: absolute;
            top: 20px;
            right: 40px;
            color: #f1f1f1;
            font-size: 40px;
            font-weight: bold;
            cursor: pointer;
        }
        .detail-modal {
            display: none;
            position: fixed;
            z-index: 1001;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.8);
            overflow-y: auto;
        }
        .detail-modal-content {
            background: #fff;
            margin: 2% auto;
            padding: 30px;
            border-radius: 15px;
            width: 90%;
            max-width: 800px;
            position: relative;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }
        .detail-close {
            position: absolute;
            top: 15px;
            right: 25px;
            font-size: 30px;
            font-weight: bold;
            color: #aaa;
            cursor: pointer;
            transition: color 0.3s;
        }
        .detail-close:hover {
            color: #e74c3c;
        }
        
        .clickable-title {
            cursor: pointer;
            color: #3498db;
            text-decoration: none;
            transition: color 0.3s;
            font-weight: bold;
        }

        .clickable-title:hover {
            color: #2980b9;
            text-decoration: underline;
        }
        
        .detail-header {
            border-bottom: 3px solid #3498db;
            padding-bottom: 15px;
            margin-bottom: 20px;
        }
        
        .detail-stats {
            background: #f8f9fa;
            padding: 15px;
            border-left: 4px solid #3498db;
            margin: 20px 0;
            border-radius: 5px;
            font-size: 14px;
            color: #2c3e50;
        }

        .detail-code {
            position: relative;
            background: #2c3e50;
            color: #ecf0f1;
            padding: 20px;
            border-radius: 10px;
            font-family: 'Courier New', monospace;
            white-space: pre-wrap;
            word-wrap: break-word;
            line-height: 1.5;
            max-height: 300px;
            overflow-y: auto;
            margin: 20px 0;
        }

        .detail-copy-btn {
            position: absolute;
            top: 10px;
            right: 10px;
            background: #3498db;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.3s;
        }

        .detail-copy-btn:hover {
            background: #2980b9;
            transform: translateY(-2px);
        }

        .detail-files {
            margin: 20px 0;
            border-top: 1px solid #ecf0f1;
            padding-top: 20px;
        }

        .detail-files h4 {
            color: #2c3e50;
            margin-bottom: 15px;
        }

        .detail-file-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 15px;
        }

        .detail-file-item {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 10px;
            padding: 15px;
            text-align: center;
            transition: all 0.3s;
        }

        .detail-file-item:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0,0,0,0.1);
        }

        .detail-image {
            max-width: 100%;
            max-height: 120px;
            border-radius: 5px;
            cursor: pointer;
            transition: transform 0.3s;
        }

        .detail-image:hover {
            transform: scale(1.05);
        }

        .detail-file-icon {
            font-size: 40px;
            margin-bottom: 10px;
        }

        .detail-file-name {
            font-weight: bold;
            color: #2c3e50;
            margin: 10px 0 5px 0;
            word-break: break-all;
            font-size: 14px;
        }

        .detail-file-size {
            color: #7f8c8d;
            font-size: 12px;
            margin-bottom: 10px;
        }

        .detail-download-btn {
            background: #27ae60;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.3s;
            width: 100%;
        }

        .detail-download-btn:hover {
            background: #229954;
            transform: translateY(-2px);
        }
        .detail-title {
            font-size: 1.8em;
            color: #2c3e50;
            margin-bottom: 10px;
            font-weight: bold;
        }
        .detail-meta {
            color: #7f8c8d;
            font-size: 14px;
        }
        .detail-code {
            background: #2c3e50;
            color: #ecf0f1;
            padding: 20px;
            border-radius: 10px;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            white-space: pre-wrap;
            word-break: break-all;
            margin: 20px 0;
            max-height: 400px;
            overflow-y: auto;
            direction: ltr;
            text-align: left;
            position: relative;
        }
        .detail-copy-btn {
            position: absolute;
            top: 15px;
            right: 15px;
            background: #3498db;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 12px;
        }
        .detail-files {
            margin: 20px 0;
        }
        .detail-files h4 {
            color: #2c3e50;
            margin-bottom: 15px;
            font-size: 1.2em;
        }
        .detail-file-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }
        .detail-file-item {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 12px;
            text-align: center;
            transition: transform 0.3s;
        }
        .detail-file-item:hover {
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        .detail-file-icon {
            font-size: 32px;
            margin-bottom: 8px;
        }
        .detail-file-name {
            font-size: 12px;
            color: #2c3e50;
            font-weight: bold;
            margin-bottom: 5px;
            word-break: break-all;
        }
        .detail-file-size {
            font-size: 11px;
            color: #7f8c8d;
            margin-bottom: 8px;
        }
        .detail-download-btn {
            background: #3498db;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 11px;
        }
        .detail-image {
            max-width: 120px;
            max-height: 120px;
            border-radius: 8px;
            cursor: pointer;
            box-shadow: 0 3px 10px rgba(0,0,0,0.1);
        }
        .detail-stats {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
            border-left: 4px solid #3498db;
        }
        .clickable-title {
            cursor: pointer;
            color: #3498db;
            transition: color 0.3s;
        }
        .clickable-title:hover {
            color: #2980b9;
            text-decoration: underline;
        }
        .clickable-row {
            cursor: pointer;
            transition: background-color 0.3s;
        }
        .clickable-row:hover {
            background-color: #e8f4fd !important;
        }
        @media (max-width: 768px) {
            .codes-grid {
                grid-template-columns: 1fr;
            }
            .container {
                padding: 15px;
            }
            .stats-box {
                flex-direction: column;
                gap: 10px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>💻 Code & Files Keeper</h1>
            <p>Save your codes with any type of files easily</p>
            <div class="info-box">
                🔒 <strong>Data Storage:</strong> All your codes and files are saved locally in your browser.
                No data is sent to external servers. Your information stays private and secure on your device only.
            </div>
        </div>

        <div class="stats-box" id="statsBox">
            <div class="stat-item">📝 <strong>Total Codes:</strong> <span id="totalCodes">0</span></div>
            <div class="stat-item">📁 <strong>Total Files:</strong> <span id="totalFiles">0</span></div>
            <div class="stat-item">🖼️ <strong>Images:</strong> <span id="totalImages">0</span></div>
            <div class="stat-item">📄 <strong>Documents:</strong> <span id="totalDocs">0</span></div>
            <div class="stat-item">💾 <strong>Total Size:</strong> <span id="totalSize">0 KB</span></div>
        </div>

        <div class="add-form">
            <h3>➕ إضافة محتوى</h3>
            
            <!-- Mode Selection -->
            <div class="content-mode-selection">
                <label class="mode-option">
                    <input type="radio" name="contentMode" value="single" checked onchange="toggleContentMode()">
                    <span>📝 إضافة كود واحد</span>
                </label>
                <label class="mode-option">
                    <input type="radio" name="contentMode" value="multiple" onchange="toggleContentMode()">
                    <span>📋 إضافة عدة أكواد منفصلة</span>
                </label>
            </div>

            <!-- Single Code Form -->
            <div id="singleCodeForm" class="content-form">
                <form id="codeForm" onsubmit="addCode(event)">
                    <div class="form-group">
                        <label for="codeTitle">عنوان الكود:</label>
                        <input type="text" id="codeTitle" placeholder="مثال: Google Analytics, Admin Access" required>
                    </div>

                    <div class="form-group">
                        <label for="codeContent">الكود:</label>
                        <textarea id="codeContent" placeholder="الصق الكود هنا..." required></textarea>
                    </div>

                    <div class="form-group">
                        <label>إضافة ملفات (صور، مستندات، إلخ):</label>
                        <div class="file-upload" onclick="document.getElementById('fileInput').click()">
                            <p>📁 انقر هنا لإضافة ملفات أو اسحب الملفات هنا</p>
                            <p style="font-size: 12px; color: #666; margin-top: 5px;">يدعم: الصور، PDF، المستندات، الملفات النصية، والمزيد</p>
                            <input type="file" id="fileInput" multiple accept="*/*" style="display: none;">
                        </div>
                        <div id="filePreview" class="preview-container"></div>
                    </div>

                    <button type="submit" class="btn">💾 حفظ الكود</button>
                </form>
            </div>

            <!-- Multiple Codes Form -->
            <div id="multipleCodesForm" class="content-form" style="display: none;">
                <div class="form-group">
                    <label for="multipleContent">الأكواد المتعددة:</label>
                    <textarea id="multipleContent" placeholder="أدخل الأكواد هنا، افصل كل كود بخط مكون من --- أو ===&#10;&#10;مثال:&#10;كود 1: عنوان الكود الأول&#10;المحتوى هنا...&#10;---&#10;كود 2: عنوان الكود الثاني&#10;المحتوى هنا..." rows="15" style="font-family: monospace;"></textarea>
                </div>

                <div class="form-group">
                    <label>إعدادات الفصل:</label>
                    <div class="separator-options">
                        <label class="separator-option">
                            <input type="radio" name="separator" value="---" checked>
                            <span>فصل بـ --- (ثلاث شرطات)</span>
                        </label>
                        <label class="separator-option">
                            <input type="radio" name="separator" value="===">
                            <span>فصل بـ === (ثلاث علامات مساواة)</span>
                        </label>
                        <label class="separator-option">
                            <input type="radio" name="separator" value="custom">
                            <span>فاصل مخصص:</span>
                            <input type="text" id="customSeparator" placeholder="أدخل الفاصل المخصص" style="margin-right: 10px;">
                        </label>
                    </div>
                </div>

                <div class="form-group">
                    <label>إضافة ملفات مشتركة لجميع الأكواد:</label>
                    <div class="file-upload" onclick="document.getElementById('multipleFileInput').click()">
                        <p>📁 انقر هنا لإضافة ملفات مشتركة</p>
                        <input type="file" id="multipleFileInput" multiple accept="*/*" style="display: none;">
                    </div>
                    <div id="multipleFilePreview" class="preview-container"></div>
                </div>

                <div class="multiple-actions">
                    <button type="button" class="btn preview-btn" onclick="previewMultipleCodes()">👁️ معاينة الأكواد</button>
                    <button type="button" class="btn" onclick="addMultipleCodes()">💾 حفظ جميع الأكواد</button>
                </div>

                <!-- Preview Area -->
                <div id="multiplePreview" class="multiple-preview" style="display: none;"></div>
            </div>
        </div>

        <!-- Unified Management Dashboard -->
        <div class="unified-dashboard">
            <div class="dashboard-header">
                <h3>🎛️ مركز التحكم</h3>
                <p>إدارة وتصدير المحتوى</p>
            </div>
            
            <div class="export-buttons">
                <div class="export-group">
                    <h4>📄 Export All Data</h4>
                    <button class="export-btn pdf-btn" onclick="exportToPDF('all')">📄 PDF Document</button>
                    <button class="export-btn word-btn" onclick="exportToWord('all')">� Word Document</button>
                    <button class="export-btn excel-btn" onclick="exportToExcel('all')">📊 Excel Spreadsheet</button>
                    <button class="export-btn note-btn" onclick="exportToNote('all')">📋 Text Notes</button>
                    <button class="export-btn json-btn" onclick="exportData()">🗂️ JSON Backup</button>
                </div>
                
                <div class="export-group">
                    <h4>🎯 Export Selected Item</h4>
                    <select id="itemSelector" class="item-selector">
                        <option value="">Select an item to export...</option>
                    </select>
                    <div class="selected-export-buttons" style="margin-top: 10px;">
                        <button class="export-btn pdf-btn" onclick="exportSelectedItem('pdf')">📄 PDF</button>
                        <button class="export-btn word-btn" onclick="exportSelectedItem('word')">📝 Word</button>
                        <button class="export-btn excel-btn" onclick="exportSelectedItem('excel')">📊 Excel</button>
                        <button class="export-btn note-btn" onclick="exportSelectedItem('note')">📋 Notes</button>
                    </div>
                </div>
            </div>
        </div>

        <div style="text-align: center; margin: 25px 0;">
            <input type="file" id="importFile" accept=".json" style="display: none;" onchange="importData(event)">
            <button class="btn" onclick="document.getElementById('importFile').click()">📥 Import Data</button>
        </div>

        <!-- Compact Import Section -->
        <div style="text-align: center; margin: 15px 0; padding: 8px; background: #f8f9fa; border-radius: 6px;">
            <input type="file" id="importFileCompact" accept=".json" style="display: none;" onchange="importData(event)">
            <button class="btn" onclick="document.getElementById('importFileCompact').click()" 
                    style="padding: 6px 12px; font-size: 12px; background: #17a2b8; color: white; border: none; border-radius: 4px;">
                📥 استيراد البيانات
            </button>
        </div>

        <!-- Modern Export Dashboard -->
        <div class="export-dashboard">
            <div class="export-header">
                <h3>مركز التصدير</h3>
                <p>صدّر المحتوى بصيغ مختلفة</p>
            </div>

            <div class="export-main-container">
                <!-- Left Panel: Selection -->
                <div class="export-panel selection-panel">
                    <div class="panel-header">
                        <h4>🎯 اختيار المحتوى</h4>
                    </div>
                    <div class="panel-content">
                        <div class="export-mode-cards">
                            <div class="mode-card active" data-mode="all" onclick="selectExportMode('all')">
                                <div class="mode-icon">📋</div>
                                <div class="mode-title">جميع الأكواد</div>
                                <div class="mode-count" id="allCodesCount">0 كود</div>
                            </div>
                            <div class="mode-card" data-mode="selected" onclick="selectExportMode('selected')">
                                <div class="mode-icon">✅</div>
                                <div class="mode-title">أكواد محددة</div>
                                <div class="mode-count" id="selectedCodesCount">اختر متعدد</div>
                            </div>
                            <div class="mode-card" data-mode="single" onclick="selectExportMode('single')">
                                <div class="mode-icon">🎯</div>
                                <div class="mode-title">كود واحد</div>
                                <div class="mode-count">اختر واحد</div>
                            </div>
                        </div>

                        <!-- Selection Details -->
                        <div id="selectionDetails" class="selection-details">
                            <div id="allModeDetails" class="mode-details active">
                                <div class="selection-summary">
                                    <p>✨ سيتم تصدير جميع الأكواد المحفوظة</p>
                                </div>
                            </div>

                            <div id="selectedModeDetails" class="mode-details">
                                <div class="items-grid" id="itemsSelectionGrid">
                                    <!-- Items will be populated by JavaScript -->
                                </div>
                                <div class="selection-actions">
                                    <button onclick="selectAllItems()" class="action-btn primary">✅ تحديد الكل</button>
                                    <button onclick="deselectAllItems()" class="action-btn secondary">❌ إلغاء الكل</button>
                                    <span id="selectedCount" class="selection-counter">0 محدد</span>
                                </div>
                            </div>

                            <div id="singleModeDetails" class="mode-details">
                                <select id="singleItemSelector" class="modern-select">
                                    <option value="">اختر كود للتصدير...</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Right Panel: Export Options -->
                <div class="export-panel formats-panel">
                    <div class="panel-header">
                        <h4>📄 أنواع التصدير</h4>
                    </div>
                    <div class="panel-content">
                        <div class="format-cards">
                            <div class="format-card pdf-card" onclick="performExport('pdf')">
                                <div class="format-icon">📄</div>
                                <div class="format-info">
                                    <div class="format-title">PDF مع الصور</div>
                                    <div class="format-desc">مستند PDF احترافي مع الصور مدمجة</div>
                                </div>
                                <div class="format-action">تصدير</div>
                            </div>

                            <div class="format-card word-card" onclick="performExport('word')">
                                <div class="format-icon">📝</div>
                                <div class="format-info">
                                    <div class="format-title">مستند Word</div>
                                    <div class="format-desc">ملف .doc قابل للتحرير</div>
                                </div>
                                <div class="format-action">تصدير</div>
                            </div>

                            <div class="format-card excel-card" onclick="performExport('excel')">
                                <div class="format-icon">📊</div>
                                <div class="format-info">
                                    <div class="format-title">جدول Excel</div>
                                    <div class="format-desc">بيانات منظمة في جداول منفصلة</div>
                                </div>
                                <div class="format-action">تصدير</div>
                            </div>

                            <div class="format-card note-card" onclick="performExport('note')">
                                <div class="format-icon">📋</div>
                                <div class="format-info">
                                    <div class="format-title">ملف نصي</div>
                                    <div class="format-desc">نص منسق بسيط وواضح</div>
                                </div>
                                <div class="format-action">تصدير</div>
                            </div>

                            <div class="format-card json-card" onclick="performExport('json')">
                                <div class="format-icon">🗂️</div>
                                <div class="format-info">
                                    <div class="format-title">نسخة احتياطية</div>
                                    <div class="format-desc">ملف JSON للاستيراد لاحقاً</div>
                                </div>
                                <div class="format-action">تصدير</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Bottom Panel: Settings -->
            <div class="export-settings-panel">
                <div class="settings-header">
                    <h4>⚙️ إعدادات التصدير</h4>
                </div>
                <div class="settings-options">
                    <label class="setting-toggle">
                        <input type="checkbox" id="includeImages" checked>
                        <span class="toggle-slider"></span>
                        <div class="setting-info">
                            <div class="setting-title">🖼️ تضمين الصور الكاملة</div>
                            <div class="setting-desc">إدراج الصور الفعلية وليس مجرد المسارات</div>
                        </div>
                    </label>

                    <label class="setting-toggle">
                        <input type="checkbox" id="includeStats" checked>
                        <span class="toggle-slider"></span>
                        <div class="setting-info">
                            <div class="setting-title">📊 تضمين الإحصائيات</div>
                            <div class="setting-desc">إضافة معلومات شاملة عن البيانات</div>
                        </div>
                    </label>

                    <label class="setting-toggle">
                        <input type="checkbox" id="includeTimestamps" checked>
                        <span class="toggle-slider"></span>
                        <div class="setting-info">
                            <div class="setting-title">🕒 تضمين التوقيتات</div>
                            <div class="setting-desc">إضافة تواريخ الإنشاء والتعديل</div>
                        </div>
                    </label>
                </div>
            </div>
        </div>

        <div style="text-align: center; margin: 25px 0;">
            <input type="file" id="importFile" accept=".json" style="display: none;" onchange="importData(event)">
            <button class="btn" onclick="document.getElementById('importFile').click()">📥 Import Data</button>
        </div>

        <input type="text" class="search-box" id="searchBox" placeholder="🔍 Search codes..." onkeyup="searchCodes()">

        <div class="view-toggle">
            <button id="gridViewBtn" class="active" onclick="switchView('grid')">🔲 Grid View</button>
            <button id="tableViewBtn" onclick="switchView('table')">📋 Table View</button>
        </div>

        <div class="codes-grid" id="codesGrid"></div>

        <table class="codes-table" id="codesTable">
            <thead>
                <tr>
                    <th>📝 Title</th>
                    <th>📁 Files</th>
                    <th>📅 Added</th>
                    <th>🔄 Modified</th>
                    <th>💾 Size</th>
                    <th>⚙️ Actions</th>
                </tr>
            </thead>
            <tbody id="codesTableBody"></tbody>
        </table>
    </div>

    <!-- Modal for viewing images -->
    <div id="imageModal" class="modal">
        <span class="close" onclick="closeModal()">&times;</span>
        <img class="modal-content" id="modalImage">
    </div>

    <!-- Modal for code details -->
    <div id="detailModal" class="detail-modal">
        <div class="detail-modal-content">
            <span class="detail-close" onclick="closeDetailModal()">&times;</span>
            <div id="detailContent"></div>
        </div>
    </div>

    <script>
        let savedCodes = JSON.parse(localStorage.getItem('savedCodes')) || [];
        let selectedFiles = [];
        let currentView = 'grid';

        // Safari compatibility fixes
        function isLocalStorageAvailable() {
            try {
                var test = 'test';
                localStorage.setItem(test, test);
                localStorage.removeItem(test);
                return true;
            } catch(e) {
                return false;
            }
        }

        // Fallback storage for Safari private mode
        var fallbackStorage = {};

        function getItem(key) {
            if (isLocalStorageAvailable()) {
                return localStorage.getItem(key);
            } else {
                return fallbackStorage[key] || null;
            }
        }

        function setItem(key, value) {
            if (isLocalStorageAvailable()) {
                localStorage.setItem(key, value);
            } else {
                fallbackStorage[key] = value;
            }
        }

        function removeItem(key) {
            if (isLocalStorageAvailable()) {
                localStorage.removeItem(key);
            } else {
                delete fallbackStorage[key];
            }
        }

        // Safari polyfills
        if (!Array.from) {
            Array.from = function(arrayLike) {
                return Array.prototype.slice.call(arrayLike);
            };
        }

        if (!Object.assign) {
            Object.assign = function(target) {
                if (target == null) {
                    throw new TypeError('Cannot convert undefined or null to object');
                }
                var to = Object(target);
                for (var index = 1; index < arguments.length; index++) {
                    var nextSource = arguments[index];
                    if (nextSource != null) {
                        for (var nextKey in nextSource) {
                            if (Object.prototype.hasOwnProperty.call(nextSource, nextKey)) {
                                to[nextKey] = nextSource[nextKey];
                            }
                        }
                    }
                }
                return to;
            };
        }

        // Global localStorage replacement for Safari compatibility
        (function() {
            var originalLS = window.localStorage;
            var safeFunctions = {
                getItem: getItem,
                setItem: setItem,
                removeItem: removeItem
            };

            // Override localStorage functions if needed
            if (!isLocalStorageAvailable()) {
                console.warn('LocalStorage not available, using fallback storage');
                window.localStorage = safeFunctions;
            }
        })();

        // Initialize the app
        document.addEventListener('DOMContentLoaded', function() {
            // Safari compatibility check
            console.log('Loading Code Keeper...');
            console.log('LocalStorage available:', isLocalStorageAvailable());
            
            try {
                setupEventListeners();
                setupMultipleFileHandling();
                displayCodes();
                updateStats();
                console.log('Code Keeper loaded successfully');
            } catch (error) {
                console.error('Error loading Code Keeper:', error);
                alert('خطأ في تحميل التطبيق. يرجى تحديث الصفحة.');
            }
        });

        function setupEventListeners() {
            // File input change
            document.getElementById('fileInput').addEventListener('change', function(e) {
                handleFileSelection(e.target.files);
            });

            // Drag and drop
            const fileUpload = document.querySelector('.file-upload');
            fileUpload.addEventListener('dragover', function(e) {
                e.preventDefault();
                fileUpload.classList.add('dragover');
            });

            fileUpload.addEventListener('dragleave', function(e) {
                e.preventDefault();
                fileUpload.classList.remove('dragover');
            });

            fileUpload.addEventListener('drop', function(e) {
                e.preventDefault();
                fileUpload.classList.remove('dragover');
                handleFileSelection(e.dataTransfer.files);
            });
        }

        function handleFileSelection(files) {
            const filePreview = document.getElementById('filePreview');
            
            Array.from(files).forEach(file => {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const fileData = {
                        name: file.name,
                        data: e.target.result,
                        type: file.type.startsWith('image/') ? 'image' : 'file',
                        mimeType: file.type,
                        size: file.size
                    };
                    
                    selectedFiles.push(fileData);
                    displayFilePreview(fileData, selectedFiles.length - 1);
                };
                reader.readAsDataURL(file);
            });
        }

        function displayFilePreview(fileData, index, isMultiple = false) {
            const previewContainer = document.createElement('div');
            const removeFunction = isMultiple ? 'removeMultipleFile' : 'removeFile';
            
            if (fileData.type === 'image') {
                previewContainer.style.cssText = 'display: inline-block; margin: 5px; position: relative;';
                previewContainer.innerHTML = `
                    <img src="${fileData.data}" class="image-preview" onclick="showImageModal('${fileData.data}')">
                    <button type="button" class="remove-btn" onclick="${removeFunction}(${index})" style="position: absolute; top: 5px; right: 5px;">×</button>
                `;
            } else {
                previewContainer.className = 'file-preview';
                previewContainer.innerHTML = `
                    <div class="file-info">
                        <div class="file-icon">${getFileIcon(fileData.mimeType, fileData.name)}</div>
                        <div class="file-details">
                            <div class="file-name">${fileData.name}</div>
                            <div class="file-size">${formatFileSize(fileData.size)}</div>
                        </div>
                    </div>
                    <button type="button" class="remove-btn" onclick="${removeFunction}(${index})">×</button>
                `;
            }
            
            if (!isMultiple) {
                const filePreview = document.getElementById('filePreview');
                filePreview.appendChild(previewContainer);
            }
            
            return previewContainer;
        }

        function removeFile(index) {
            selectedFiles.splice(index, 1);
            refreshFilePreview();
        }

        function refreshFilePreview() {
            const filePreview = document.getElementById('filePreview');
            filePreview.innerHTML = '';
            selectedFiles.forEach((file, index) => {
                displayFilePreview(file, index);
            });
        }

        function getFileIcon(mimeType, fileName) {
            if (mimeType.startsWith('image/')) return '🖼️';
            if (mimeType.includes('pdf')) return '📄';
            if (mimeType.includes('word') || fileName.endsWith('.doc') || fileName.endsWith('.docx')) return '📝';
            if (mimeType.includes('excel') || fileName.endsWith('.xls') || fileName.endsWith('.xlsx')) return '📊';
            if (mimeType.includes('powerpoint') || fileName.endsWith('.ppt') || fileName.endsWith('.pptx')) return '📈';
            if (mimeType.includes('text') || fileName.endsWith('.txt')) return '📋';
            if (mimeType.includes('zip') || fileName.endsWith('.zip') || fileName.endsWith('.rar')) return '🗜️';
            if (mimeType.includes('video')) return '🎥';
            if (mimeType.includes('audio')) return '🎵';
            return '📁';
        }

        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        function addCode(event) {
            event.preventDefault();
            
            const title = document.getElementById('codeTitle').value.trim();
            const content = document.getElementById('codeContent').value.trim();
            
            if (!title || !content) {
                alert('Please fill in both title and code fields.');
                return;
            }

            const now = new Date();
            const newCode = {
                id: Date.now(),
                title: title,
                content: content,
                files: [...selectedFiles],
                dateAdded: now.toLocaleDateString('en-US'),
                timeAdded: now.toLocaleTimeString('en-US'),
                dateModified: now.toLocaleDateString('en-US'),
                timeModified: now.toLocaleTimeString('en-US')
            };

            savedCodes.push(newCode);
            localStorage.setItem('savedCodes', JSON.stringify(savedCodes));
            
            // Reset form
            document.getElementById('codeForm').reset();
            document.getElementById('filePreview').innerHTML = '';
            selectedFiles = [];
            
            displayCodes();
            updateStats();
            alert('✅ Code saved successfully!');
        }

        function displayCodes() {
            if (currentView === 'grid') {
                displayGridView();
            } else {
                displayTableView();
            }
            // Update item selector for export
            updateItemSelector();
        }

        function displayGridView() {
            const grid = document.getElementById('codesGrid');
            const table = document.getElementById('codesTable');
            
            grid.style.display = 'grid';
            table.style.display = 'none';
            grid.innerHTML = '';

            if (savedCodes.length === 0) {
                grid.innerHTML = '<p style="text-align: center; color: #7f8c8d; font-size: 18px; grid-column: 1/-1; padding: 30px;">📝 No saved codes yet</p>';
                return;
            }

            savedCodes.forEach(code => {
                const card = createCodeCard(code);
                grid.appendChild(card);
            });
        }

        function displayTableView() {
            const grid = document.getElementById('codesGrid');
            const table = document.getElementById('codesTable');
            const tbody = document.getElementById('codesTableBody');
            
            grid.style.display = 'none';
            table.style.display = 'table';
            tbody.innerHTML = '';

            if (savedCodes.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; color: #7f8c8d; padding: 30px;">📝 No saved codes yet</td></tr>';
                return;
            }

            savedCodes.forEach(code => {
                const row = createTableRow(code);
                tbody.appendChild(row);
            });
        }

        function createCodeCard(code) {
            const card = document.createElement('div');
            card.className = 'code-card';

            const images = code.files ? code.files.filter(f => f.type === 'image').length : 0;
            const docs = code.files ? code.files.filter(f => f.type === 'file').length : 0;
            const totalSize = code.files ? code.files.reduce((sum, f) => sum + (f.size || 0), 0) : 0;

            const filesHtml = code.files && code.files.length > 0 
                ? `<div class="files-section">
                     <h4 style="color: #2c3e50; margin-bottom: 10px;">📁 Attached Files (${code.files.length}):</h4>
                     <div class="attached-files">
                         ${code.files.map(file => {
                             if (file.type === 'image') {
                                 return `<img src="${file.data}" class="image-preview" onclick="showImageModal('${file.data}')" title="${file.name}">`;
                             } else {
                                 return `<div class="file-preview" style="margin: 5px 0;">
                                           <div class="file-info">
                                             <div class="file-icon">${getFileIcon(file.mimeType, file.name)}</div>
                                             <div class="file-details">
                                               <div class="file-name">${file.name}</div>
                                               <div class="file-size">${formatFileSize(file.size || 0)}</div>
                                             </div>
                                           </div>
                                           <button onclick="downloadFile('${file.data}', '${file.name}')" class="action-btn">📥</button>
                                         </div>`;
                             }
                         }).join('')}
                     </div>
                   </div>`
                : '';

            card.innerHTML = `
                <div class="code-header">
                    <div class="code-title clickable-title" onclick="showCodeDetail(${code.id})">${code.title}</div>
                    <button class="delete-btn" onclick="deleteCode(${code.id})">🗑️ Delete</button>
                </div>
                
                <div class="code-content">
                    <h4 style="color: #2c3e50; margin-bottom: 8px;">💻 Code:</h4>
                    <div class="code-box">
                        <button class="copy-btn" onclick="copyCode(${code.id})">📋 Copy</button>
                        ${code.content.length > 200 ? code.content.substring(0, 200) + '...' : code.content}
                    </div>
                    ${code.content.length > 200 ? `<p style="text-align: center; margin: 10px 0;"><button onclick="showCodeDetail(${code.id})" style="background: #3498db; color: white; border: none; padding: 5px 15px; border-radius: 5px; cursor: pointer;">📖 View Full Code</button></p>` : ''}
                </div>
                
                ${filesHtml}
                
                <div class="stats-info">
                    📊 <strong>Stats:</strong> ${code.files ? code.files.length : 0} files 
                    (🖼️ ${images} images, 📄 ${docs} docs) | 💾 ${formatFileSize(totalSize)} |
                    📅 Added: ${code.dateAdded} ${code.timeAdded} |
                    🔄 Modified: ${code.dateModified} ${code.timeModified}
                </div>
            `;

            return card;
        }

        function createTableRow(code) {
            const row = document.createElement('tr');
            const images = code.files ? code.files.filter(f => f.type === 'image').length : 0;
            const docs = code.files ? code.files.filter(f => f.type === 'file').length : 0;
            const totalSize = code.files ? code.files.reduce((sum, f) => sum + (f.size || 0), 0) : 0;

            row.innerHTML = `
                <td class="clickable-row" onclick="showCodeDetail(${code.id})">
                    <strong class="clickable-title">${code.title}</strong><br>
                    <small style="color: #666;">${code.content.substring(0, 50)}${code.content.length > 50 ? '...' : ''}</small>
                </td>
                <td class="clickable-row" onclick="showCodeDetail(${code.id})">
                    ${code.files ? code.files.length : 0} files<br>
                    <small>🖼️ ${images} images, 📄 ${docs} docs</small>
                </td>
                <td class="clickable-row" onclick="showCodeDetail(${code.id})">${code.dateAdded}<br><small>${code.timeAdded}</small></td>
                <td class="clickable-row" onclick="showCodeDetail(${code.id})">${code.dateModified}<br><small>${code.timeModified}</small></td>
                <td class="clickable-row" onclick="showCodeDetail(${code.id})">${formatFileSize(totalSize)}</td>
                <td>
                    <button onclick="copyCode(${code.id})" class="action-btn" title="Copy">📋</button>
                    <button onclick="editCode(${code.id})" class="action-btn edit-btn" title="Edit">✏️</button>
                    <button onclick="deleteCode(${code.id})" class="action-btn del-btn" title="Delete">🗑️</button>
                </td>
            `;
            return row;
        }

        function copyCode(codeId) {
            const code = savedCodes.find(c => c.id === codeId);
            if (code) {
                navigator.clipboard.writeText(code.content).then(() => {
                    const btn = event.target;
                    const originalText = btn.textContent;
                    btn.textContent = '✅';
                    btn.style.background = '#27ae60';
                    setTimeout(() => {
                        btn.textContent = originalText;
                        btn.style.background = '#3498db';
                    }, 2000);
                }).catch(() => {
                    alert('Code copied to clipboard!');
                });
            }
        }

        function editCode(codeId) {
            const code = savedCodes.find(c => c.id === codeId);
            if (code) {
                document.getElementById('codeTitle').value = code.title;
                document.getElementById('codeContent').value = code.content;
                
                // Load files
                selectedFiles = code.files ? [...code.files] : [];
                refreshFilePreview();
                
                // Update modification date
                const now = new Date();
                code.dateModified = now.toLocaleDateString('en-US');
                code.timeModified = now.toLocaleTimeString('en-US');
                
                // Remove from saved codes for editing
                savedCodes = savedCodes.filter(c => c.id !== codeId);
                localStorage.setItem('savedCodes', JSON.stringify(savedCodes));
                displayCodes();
                updateStats();
                
                alert('✏️ Code loaded for editing. Make your changes and click Save.');
            }
        }

        function deleteCode(codeId) {
            if (confirm('Are you sure you want to delete this code?')) {
                savedCodes = savedCodes.filter(code => code.id !== codeId);
                localStorage.setItem('savedCodes', JSON.stringify(savedCodes));
                displayCodes();
                updateStats();
                alert('🗑️ Code deleted successfully!');
            }
        }

        function switchView(view) {
            currentView = view;
            document.getElementById('gridViewBtn').classList.toggle('active', view === 'grid');
            document.getElementById('tableViewBtn').classList.toggle('active', view === 'table');
            displayCodes();
        }

        function updateStats() {
            const totalCodes = savedCodes.length;
            let totalFiles = 0, totalImages = 0, totalDocs = 0, totalSize = 0;

            savedCodes.forEach(code => {
                if (code.files) {
                    totalFiles += code.files.length;
                    totalImages += code.files.filter(f => f.type === 'image').length;
                    totalDocs += code.files.filter(f => f.type === 'file').length;
                    totalSize += code.files.reduce((sum, f) => sum + (f.size || 0), 0);
                }
            });

            document.getElementById('totalCodes').textContent = totalCodes;
            document.getElementById('totalFiles').textContent = totalFiles;
            document.getElementById('totalImages').textContent = totalImages;
            document.getElementById('totalDocs').textContent = totalDocs;
            document.getElementById('totalSize').textContent = formatFileSize(totalSize);
        }

        function searchCodes() {
            const searchTerm = document.getElementById('searchBox').value.toLowerCase();
            const cards = document.querySelectorAll('.code-card');
            const rows = document.querySelectorAll('#codesTableBody tr');

            cards.forEach(card => {
                const text = card.textContent.toLowerCase();
                card.style.display = text.includes(searchTerm) ? 'block' : 'none';
            });

            rows.forEach(row => {
                const text = row.textContent.toLowerCase();
                row.style.display = text.includes(searchTerm) ? 'table-row' : 'none';
            });
        }

        function showImageModal(imageSrc) {
            const modal = document.getElementById('imageModal');
            const modalImg = document.getElementById('modalImage');
            modal.style.display = 'block';
            modalImg.src = imageSrc;
        }

        function closeModal() {
            document.getElementById('imageModal').style.display = 'none';
        }

        function showCodeDetail(codeId) {
            const code = savedCodes.find(c => c.id === codeId);
            if (!code) return;

            const images = code.files ? code.files.filter(f => f.type === 'image').length : 0;
            const docs = code.files ? code.files.filter(f => f.type === 'file').length : 0;
            const totalSize = code.files ? code.files.reduce((sum, f) => sum + (f.size || 0), 0) : 0;

            const filesHtml = code.files && code.files.length > 0 
                ? `<div class="detail-files">
                     <h4>📁 Attached Files (${code.files.length})</h4>
                     <div class="detail-file-grid">
                         ${code.files.map(file => {
                             if (file.type === 'image') {
                                 return `<div class="detail-file-item">
                                           <img src="${file.data}" class="detail-image" onclick="showImageModal('${file.data}')" title="Click to enlarge">
                                           <div class="detail-file-name">${file.name}</div>
                                           <div class="detail-file-size">${formatFileSize(file.size || 0)}</div>
                                           <button onclick="downloadFile('${file.data}', '${file.name}')" class="detail-download-btn">📥 Download</button>
                                         </div>`;
                             } else {
                                 return `<div class="detail-file-item">
                                           <div class="detail-file-icon">${getFileIcon(file.mimeType, file.name)}</div>
                                           <div class="detail-file-name">${file.name}</div>
                                           <div class="detail-file-size">${formatFileSize(file.size || 0)}</div>
                                           <button onclick="downloadFile('${file.data}', '${file.name}')" class="detail-download-btn">📥 Download</button>
                                         </div>`;
                             }
                         }).join('')}
                     </div>
                   </div>`
                : '<div class="detail-files"><p style="color: #7f8c8d; text-align: center; padding: 20px;">No files attached</p></div>';

            const detailContent = `
                <div class="detail-header">
                    <div class="detail-title">${code.title}</div>
                    <div class="detail-meta">
                        📅 Added: ${code.dateAdded} at ${code.timeAdded} | 
                        🔄 Modified: ${code.dateModified} at ${code.timeModified}
                    </div>
                </div>

                <div class="detail-stats">
                    <strong>📊 Statistics:</strong><br>
                    📁 Total Files: ${code.files ? code.files.length : 0} | 
                    🖼️ Images: ${images} | 
                    📄 Documents: ${docs} | 
                    💾 Total Size: ${formatFileSize(totalSize)}
                </div>

                <h4 style="color: #2c3e50; margin: 20px 0 10px 0;">💻 Code:</h4>
                <div class="detail-code">
                    <button class="detail-copy-btn" onclick="copyCodeText('${code.id}')">📋 Copy Code</button>
                    ${code.content}
                </div>

                ${filesHtml}

                <div style="text-align: center; margin-top: 30px;">
                    <button onclick="editCode(${code.id}); closeDetailModal();" style="background: #f39c12; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; margin: 0 10px;">✏️ Edit Code</button>
                    <button onclick="if(confirm('Are you sure you want to delete this code?')) { deleteCode(${code.id}); closeDetailModal(); }" style="background: #e74c3c; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; margin: 0 10px;">🗑️ Delete Code</button>
                </div>
            `;

            document.getElementById('detailContent').innerHTML = detailContent;
            document.getElementById('detailModal').style.display = 'block';
        }

        function closeDetailModal() {
            document.getElementById('detailModal').style.display = 'none';
        }

        function copyCodeText(codeId) {
            const code = savedCodes.find(c => c.id === codeId);
            if (code) {
                navigator.clipboard.writeText(code.content).then(() => {
                    const btn = event.target;
                    const originalText = btn.textContent;
                    btn.textContent = '✅ Copied!';
                    btn.style.background = '#27ae60';
                    setTimeout(() => {
                        btn.textContent = originalText;
                        btn.style.background = '#3498db';
                    }, 2000);
                }).catch(() => {
                    alert('Code copied to clipboard!');
                });
            }
        }

        function downloadFile(dataUrl, fileName) {
            const link = document.createElement('a');
            link.href = dataUrl;
            link.download = fileName;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        function downloadFile(dataUrl, filename) {
            const link = document.createElement('a');
            link.href = dataUrl;
            link.download = filename;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        function exportData() {
            if (savedCodes.length === 0) {
                alert('No data to export!');
                return;
            }
            
            const dataStr = JSON.stringify(savedCodes, null, 2);
            const dataBlob = new Blob([dataStr], {type: 'application/json'});
            
            const link = document.createElement('a');
            link.href = URL.createObjectURL(dataBlob);
            link.download = `code-keeper-backup-${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            alert('📤 Data exported successfully!');
        }

        // Advanced Export Functions
        function exportToPDF(mode) {
            if (savedCodes.length === 0) {
                alert('No data to export!');
                return;
            }

            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            let yPosition = 20;
            const pageHeight = doc.internal.pageSize.height;
            const marginBottom = 20;

            // Title
            doc.setFontSize(20);
            doc.setTextColor(44, 62, 80);
            doc.text('Code & Files Keeper - Export', 20, yPosition);
            yPosition += 20;

            // Date
            doc.setFontSize(12);
            doc.setTextColor(127, 140, 141);
            doc.text(`Export Date: ${new Date().toLocaleDateString()}`, 20, yPosition);
            yPosition += 15;

            // Statistics
            const totalFiles = savedCodes.reduce((sum, code) => sum + (code.files ? code.files.length : 0), 0);
            const totalImages = savedCodes.reduce((sum, code) => sum + (code.files ? code.files.filter(f => f.type === 'image').length : 0), 0);
            
            doc.setFontSize(11);
            doc.setTextColor(39, 174, 96);
            doc.text(`Total Codes: ${savedCodes.length} | Total Files: ${totalFiles} | Images: ${totalImages}`, 20, yPosition);
            yPosition += 20;

            savedCodes.forEach((code, index) => {
                // Check if we need a new page
                if (yPosition > pageHeight - marginBottom - 60) {
                    doc.addPage();
                    yPosition = 20;
                }

                // Code header
                doc.setFontSize(14);
                doc.setTextColor(52, 152, 219);
                doc.text(`${index + 1}. ${code.title}`, 20, yPosition);
                yPosition += 10;

                // Date info
                doc.setFontSize(10);
                doc.setTextColor(127, 140, 141);
                doc.text(`Added: ${code.dateAdded} | Modified: ${code.dateModified}`, 25, yPosition);
                yPosition += 10;

                // Code content
                doc.setFontSize(9);
                doc.setTextColor(44, 62, 80);
                const codeLines = code.content.split('\n');
                codeLines.forEach(line => {
                    if (yPosition > pageHeight - marginBottom - 10) {
                        doc.addPage();
                        yPosition = 20;
                    }
                    doc.text(line.substring(0, 90), 25, yPosition);
                    yPosition += 5;
                });

                // Files info
                if (code.files && code.files.length > 0) {
                    yPosition += 5;
                    doc.setFontSize(10);
                    doc.setTextColor(230, 126, 34);
                    doc.text(`📁 Attached Files (${code.files.length}):`, 25, yPosition);
                    yPosition += 8;

                    code.files.forEach(file => {
                        if (yPosition > pageHeight - marginBottom - 10) {
                            doc.addPage();
                            yPosition = 20;
                        }
                        doc.setFontSize(9);
                        doc.setTextColor(127, 140, 141);
                        doc.text(`- ${file.name} (${formatFileSize(file.size || 0)})`, 30, yPosition);
                        yPosition += 6;
                    });
                }

                yPosition += 15;
            });

            doc.save(`code-keeper-export-${new Date().toISOString().split('T')[0]}.pdf`);
            alert('📄 PDF exported successfully!');
        }

        function exportToWord(mode) {
            if (savedCodes.length === 0) {
                alert('No data to export!');
                return;
            }

            let wordContent = `Code & Files Keeper - Export\n`;
            wordContent += `Export Date: ${new Date().toLocaleDateString()}\n`;
            wordContent += `Total Codes: ${savedCodes.length}\n\n`;
            wordContent += `==========================================\n\n`;

            savedCodes.forEach((code, index) => {
                wordContent += `${index + 1}. ${code.title}\n`;
                wordContent += `Added: ${code.dateAdded} | Modified: ${code.dateModified}\n`;
                wordContent += `Code:\n${code.content}\n\n`;
                
                if (code.files && code.files.length > 0) {
                    wordContent += `Attached Files (${code.files.length}):\n`;
                    code.files.forEach(file => {
                        wordContent += `- ${file.name} (${formatFileSize(file.size || 0)})\n`;
                    });
                    wordContent += '\n';
                }
                wordContent += `------------------------------------------\n\n`;
            });

            const blob = new Blob([wordContent], { type: 'application/vnd.openxmlformats-officedocument.wordprocessingml.document' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `code-keeper-export-${new Date().toISOString().split('T')[0]}.doc`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            alert('📝 Word document exported successfully!');
        }

        function exportToExcel(mode) {
            if (savedCodes.length === 0) {
                alert('No data to export!');
                return;
            }

            const workbook = XLSX.utils.book_new();
            
            // Main data sheet
            const mainData = savedCodes.map((code, index) => ({
                'ID': index + 1,
                'Title': code.title,
                'Date Added': code.dateAdded,
                'Time Added': code.timeAdded,
                'Date Modified': code.dateModified,
                'Time Modified': code.timeModified,
                'Code Content': code.content,
                'Files Count': code.files ? code.files.length : 0,
                'Images Count': code.files ? code.files.filter(f => f.type === 'image').length : 0,
                'Total Size (Bytes)': code.files ? code.files.reduce((sum, f) => sum + (f.size || 0), 0) : 0
            }));

            const mainSheet = XLSX.utils.json_to_sheet(mainData);
            XLSX.utils.book_append_sheet(workbook, mainSheet, 'Codes');

            // Files sheet
            const filesData = [];
            savedCodes.forEach((code, codeIndex) => {
                if (code.files && code.files.length > 0) {
                    code.files.forEach(file => {
                        filesData.push({
                            'Code ID': codeIndex + 1,
                            'Code Title': code.title,
                            'File Name': file.name,
                            'File Type': file.type,
                            'File Size (Bytes)': file.size || 0,
                            'File Size': formatFileSize(file.size || 0),
                            'MIME Type': file.mimeType || 'unknown'
                        });
                    });
                }
            });

            if (filesData.length > 0) {
                const filesSheet = XLSX.utils.json_to_sheet(filesData);
                XLSX.utils.book_append_sheet(workbook, filesSheet, 'Files');
            }

            // Statistics sheet
            const statsData = [{
                'Metric': 'Total Codes',
                'Value': savedCodes.length
            }, {
                'Metric': 'Total Files',
                'Value': savedCodes.reduce((sum, code) => sum + (code.files ? code.files.length : 0), 0)
            }, {
                'Metric': 'Total Images',
                'Value': savedCodes.reduce((sum, code) => sum + (code.files ? code.files.filter(f => f.type === 'image').length : 0), 0)
            }, {
                'Metric': 'Total Size (Bytes)',
                'Value': savedCodes.reduce((sum, code) => sum + (code.files ? code.files.reduce((s, f) => s + (f.size || 0), 0) : 0), 0)
            }, {
                'Metric': 'Export Date',
                'Value': new Date().toLocaleDateString()
            }];

            const statsSheet = XLSX.utils.json_to_sheet(statsData);
            XLSX.utils.book_append_sheet(workbook, statsSheet, 'Statistics');

            XLSX.writeFile(workbook, `code-keeper-export-${new Date().toISOString().split('T')[0]}.xlsx`);
            alert('📊 Excel file exported successfully!');
        }

        function exportToNote(mode) {
            if (savedCodes.length === 0) {
                alert('No data to export!');
                return;
            }

            let noteContent = `CODE & FILES KEEPER - EXPORT\n`;
            noteContent += `${'='.repeat(50)}\n`;
            noteContent += `Export Date: ${new Date().toLocaleString()}\n`;
            noteContent += `Total Codes: ${savedCodes.length}\n`;
            noteContent += `Total Files: ${savedCodes.reduce((sum, code) => sum + (code.files ? code.files.length : 0), 0)}\n\n`;

            savedCodes.forEach((code, index) => {
                noteContent += `${'-'.repeat(50)}\n`;
                noteContent += `${index + 1}. ${code.title.toUpperCase()}\n`;
                noteContent += `${'-'.repeat(50)}\n`;
                noteContent += `Added: ${code.dateAdded} at ${code.timeAdded}\n`;
                noteContent += `Modified: ${code.dateModified} at ${code.timeModified}\n\n`;
                noteContent += `CODE:\n`;
                noteContent += `${code.content}\n\n`;
                
                if (code.files && code.files.length > 0) {
                    noteContent += `ATTACHED FILES (${code.files.length}):\n`;
                    code.files.forEach((file, fileIndex) => {
                        noteContent += `  ${fileIndex + 1}. ${file.name}\n`;
                        noteContent += `     Type: ${file.type}\n`;
                        noteContent += `     Size: ${formatFileSize(file.size || 0)}\n`;
                        if (file.mimeType) noteContent += `     MIME: ${file.mimeType}\n`;
                        noteContent += `\n`;
                    });
                }
                noteContent += `\n`;
            });

            noteContent += `${'-'.repeat(50)}\n`;
            noteContent += `End of Export - Generated by Code & Files Keeper\n`;

            const blob = new Blob([noteContent], { type: 'text/plain' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `code-keeper-notes-${new Date().toISOString().split('T')[0]}.txt`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            alert('📋 Text notes exported successfully!');
        }

        function exportSelectedItem(format) {
            const selectedId = document.getElementById('itemSelector').value;
            if (!selectedId) {
                alert('Please select an item to export!');
                return;
            }

            const selectedCode = savedCodes.find(code => code.id == selectedId);
            if (!selectedCode) {
                alert('Selected item not found!');
                return;
            }

            // Temporarily modify savedCodes to export only selected item
            const originalCodes = [...savedCodes];
            savedCodes = [selectedCode];

            switch(format) {
                case 'pdf':
                    exportToPDF('single');
                    break;
                case 'word':
                    exportToWord('single');
                    break;
                case 'excel':
                    exportToExcel('single');
                    break;
                case 'note':
                    exportToNote('single');
                    break;
            }

            // Restore original codes
            savedCodes = originalCodes;
        }

        function updateItemSelector() {
            const selector = document.getElementById('itemSelector');
            const singleSelector = document.getElementById('singleItemSelector');
            
            // Update both selectors
            [selector, singleSelector].forEach(sel => {
                if (sel) {
                    sel.innerHTML = '<option value="">Select an item to export...</option>';
                    savedCodes.forEach(code => {
                        const option = document.createElement('option');
                        option.value = code.id;
                        option.textContent = `${code.title} (${code.dateAdded})`;
                        sel.appendChild(option);
                    });
                }
            });
            
            updateItemsChecklist();
            
            // Update export all text
            const exportAllText = document.getElementById('exportAllText');
            if (exportAllText) {
                exportAllText.textContent = `📋 Export All Codes (${savedCodes.length})`;
            }
        }

        function updateExportMode() {
            const mode = document.querySelector('input[name="exportMode"]:checked').value;
            const selectedSection = document.getElementById('selectedItemsSection');
            const singleSection = document.getElementById('singleItemSection');
            
            selectedSection.style.display = mode === 'selected' ? 'block' : 'none';
            singleSection.style.display = mode === 'single' ? 'block' : 'none';
            
            if (mode === 'selected') {
                updateItemsChecklist();
            }
        }

        function updateItemsChecklist() {
            const checklist = document.getElementById('itemsChecklist');
            if (!checklist) return;
            
            checklist.innerHTML = '';
            
            savedCodes.forEach(code => {
                const item = document.createElement('div');
                item.className = 'checklist-item';
                
                const images = code.files ? code.files.filter(f => f.type === 'image').length : 0;
                const docs = code.files ? code.files.filter(f => f.type === 'file').length : 0;
                
                item.innerHTML = `
                    <input type="checkbox" id="item_${code.id}" value="${code.id}" onchange="updateSelectedCount()">
                    <div class="checklist-item-info">
                        <div class="checklist-item-title">${code.title}</div>
                        <div class="checklist-item-meta">
                            📅 ${code.dateAdded} | 📁 ${code.files ? code.files.length : 0} files | 🖼️ ${images} images
                        </div>
                    </div>
                `;
                
                checklist.appendChild(item);
            });
            
            updateSelectedCount();
        }

        function selectAllItems() {
            const checkboxes = document.querySelectorAll('#itemsChecklist input[type="checkbox"]');
            checkboxes.forEach(cb => cb.checked = true);
            updateSelectedCount();
        }

        function deselectAllItems() {
            const checkboxes = document.querySelectorAll('#itemsChecklist input[type="checkbox"]');
            checkboxes.forEach(cb => cb.checked = false);
            updateSelectedCount();
        }

        function updateSelectedCount() {
            const checkboxes = document.querySelectorAll('#itemsChecklist input[type="checkbox"]:checked');
            const countSpan = document.getElementById('selectedCount');
            if (countSpan) {
                countSpan.textContent = `${checkboxes.length} items selected`;
            }
        }

        function getSelectedItems() {
            const mode = document.querySelector('input[name="exportMode"]:checked').value;
            
            if (mode === 'all') {
                return savedCodes;
            } else if (mode === 'selected') {
                const checkboxes = document.querySelectorAll('#itemsChecklist input[type="checkbox"]:checked');
                const selectedIds = Array.from(checkboxes).map(cb => parseInt(cb.value));
                return savedCodes.filter(code => selectedIds.includes(code.id));
            } else if (mode === 'single') {
                const selectedId = document.getElementById('singleItemSelector').value;
                return selectedId ? [savedCodes.find(code => code.id == selectedId)] : [];
            }
            
            return [];
        }

        function performExport(format) {
            const selectedItems = getSelectedItems();
            
            if (selectedItems.length === 0) {
                alert('Please select at least one item to export!');
                return;
            }
            
            // Temporarily modify savedCodes for export
            const originalCodes = [...savedCodes];
            savedCodes = selectedItems;
            
            // Get settings
            const includeImages = document.getElementById('includeImages').checked;
            const includeStats = document.getElementById('includeStats').checked;
            const includeTimestamps = document.getElementById('includeTimestamps').checked;
            
            try {
                switch(format) {
                    case 'pdf':
                        exportToPDFWithImages(includeImages, includeStats, includeTimestamps);
                        break;
                    case 'word':
                        exportToWordWithImages(includeImages, includeStats, includeTimestamps);
                        break;
                    case 'excel':
                        exportToExcelAdvanced(includeImages, includeStats, includeTimestamps);
                        break;
                    case 'note':
                        exportToNote('advanced');
                        break;
                    case 'json':
                        exportData();
                        break;
                }
            } finally {
                // Restore original codes
                savedCodes = originalCodes;
            }
        }

        // Export mode functionality
        function selectExportMode(mode) {
            // Remove active class from all cards
            document.querySelectorAll('.mode-card').forEach(card => {
                card.classList.remove('active');
            });
            
            // Add active class to selected card
            document.querySelector(`[onclick="selectExportMode('${mode}')"]`).classList.add('active');
            
            // Hide all mode details
            document.querySelectorAll('.mode-details').forEach(detail => {
                detail.classList.remove('active');
            });
            
            // Show selected mode details
            document.getElementById(`mode-${mode}`).classList.add('active');
            
            updateSelectionDetails(mode);
        }

        function updateSelectionDetails(mode) {
            const codeEntries = JSON.parse(getItem('codeEntries') || '[]');
            
            if (mode === 'all') {
                updateModeCount('all', codeEntries.length);
                showItemsGrid(codeEntries, false);
            } else if (mode === 'selected') {
                updateModeCount('selected', 0);
                showItemsGrid(codeEntries, true);
            } else if (mode === 'single') {
                showSingleSelect(codeEntries);
            }
        }

        function updateModeCount(mode, count) {
            const modeCard = document.querySelector(`[onclick="selectExportMode('${mode}')"] .mode-count`);
            if (modeCard) {
                modeCard.textContent = `${count} عنصر`;
            }
        }

        function showItemsGrid(entries, selectable = false) {
            const containerId = selectable ? 'items-grid-selected' : 'items-grid-all';
            const container = document.getElementById(containerId);
            if (!container) return;
            
            container.innerHTML = '';
            
            entries.forEach((entry, index) => {
                const itemCard = document.createElement('div');
                itemCard.className = 'item-card';
                if (selectable) {
                    itemCard.onclick = () => toggleItemSelection(itemCard, index);
                }
                
                itemCard.innerHTML = `
                    <div class="item-card-title">${entry.title || entry.name || `الكود ${index + 1}`}</div>
                    <div class="item-card-meta">
                        ${entry.language || entry.type || 'نص'} • 
                        ${entry.images ? entry.images.length : 0} صورة
                    </div>
                `;
                
                container.appendChild(itemCard);
            });
        }

        function showSingleSelect(entries) {
            const select = document.getElementById('single-select');
            if (!select) return;
            
            select.innerHTML = '<option value="">اختر عنصر واحد...</option>';
            
            entries.forEach((entry, index) => {
                const option = document.createElement('option');
                option.value = index;
                option.textContent = entry.title || entry.name || `الكود ${index + 1}`;
                select.appendChild(option);
            });
        }

        function toggleItemSelection(card, index) {
            card.classList.toggle('selected');
            updateSelectedCount();
        }

        function selectAllItems() {
            document.querySelectorAll('#items-grid-selected .item-card').forEach(card => {
                card.classList.add('selected');
            });
            updateSelectedCount();
        }

        function clearAllSelection() {
            document.querySelectorAll('#items-grid-selected .item-card').forEach(card => {
                card.classList.remove('selected');
            });
            updateSelectedCount();
        }

        function updateSelectedCount() {
            const selectedItems = document.querySelectorAll('#items-grid-selected .item-card.selected').length;
            const counter = document.querySelector('.selection-counter');
            if (counter) {
                counter.textContent = `${selectedItems} محدد`;
            }
            updateModeCount('selected', selectedItems);
        }

        function exportWithFormat(format) {
            const activeMode = document.querySelector('.mode-card.active');
            if (!activeMode) {
                alert('يرجى اختيار نمط التصدير أولاً');
                return;
            }
            
            const mode = activeMode.getAttribute('onclick').match(/selectExportMode\('(.+?)'\)/)[1];
            const entries = getSelectedEntries(mode);
            
            if (entries.length === 0) {
                alert('لا توجد عناصر للتصدير');
                return;
            }
            
            // Get export settings
            const settings = {
                includeImages: document.getElementById('include-images')?.checked !== false,
                includeMetadata: document.getElementById('include-metadata')?.checked !== false,
                compressImages: document.getElementById('compress-images')?.checked !== false,
                createIndex: document.getElementById('create-index')?.checked !== false
            };
            
            // Prepare data for legacy functions
            window.savedCodes = entries;
            
            // Call appropriate export function
            switch (format) {
                case 'pdf':
                    exportToPDFWithImages(settings.includeImages, settings.includeMetadata, settings.includeMetadata);
                    break;
                case 'word':
                    exportToWord();
                    break;
                case 'excel':
                    exportToExcelAdvanced();
                    break;
                case 'note':
                    exportAsNote();
                    break;
                case 'json':
                    exportData();
                    break;
            }
        }

        function getSelectedEntries(mode) {
            const allEntries = JSON.parse(getItem('codeEntries') || '[]');
            
            switch (mode) {
                case 'all':
                    return allEntries;
                case 'selected':
                    const selectedIndices = [];
                    document.querySelectorAll('#items-grid-selected .item-card.selected').forEach((card, index) => {
                        const actualIndex = Array.from(card.parentNode.children).indexOf(card);
                        selectedIndices.push(actualIndex);
                    });
                    return selectedIndices.map(index => allEntries[index]).filter(Boolean);
                case 'single':
                    const selectElement = document.getElementById('single-select');
                    const selectedIndex = selectElement.value;
                    return selectedIndex !== '' ? [allEntries[selectedIndex]] : [];
                default:
                    return [];
            }
        }

        // Initialize export dashboard on page load
        document.addEventListener('DOMContentLoaded', function() {
            // Set default export mode
            selectExportMode('all');
        });

        // Unified Dashboard Functions
        function focusSearch() {
            const searchInput = document.getElementById('searchInput');
            if (searchInput) {
                searchInput.focus();
                searchInput.scrollIntoView({ behavior: 'smooth' });
            }
        }

        function showStats() {
            const statsBox = document.getElementById('statsBox');
            if (statsBox) {
                statsBox.scrollIntoView({ behavior: 'smooth' });
                // Add a subtle animation
                statsBox.style.transform = 'scale(1.05)';
                setTimeout(() => {
                    statsBox.style.transform = 'scale(1)';
                }, 300);
            }
        }

        function toggleView() {
            const gridView = document.getElementById('gridView');
            const tableView = document.getElementById('tableView');
            
            if (gridView && tableView) {
                if (gridView.style.display === 'none') {
                    gridView.style.display = 'block';
                    tableView.style.display = 'none';
                } else {
                    gridView.style.display = 'none';
                    tableView.style.display = 'block';
                }
            }
        }

        // Enhanced Export Functions with Full Image Support
        function exportToPDFWithImages(includeImages, includeStats, includeTimestamps) {
            if (savedCodes.length === 0) {
                alert('No data to export!');
                return;
            }

            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            let yPosition = 20;
            const pageHeight = doc.internal.pageSize.height;
            const pageWidth = doc.internal.pageSize.width;
            const marginBottom = 20;
            const marginLeft = 20;

            // Title
            doc.setFontSize(20);
            doc.setTextColor(44, 62, 80);
            doc.text('Code & Files Keeper - Advanced Export', marginLeft, yPosition);
            yPosition += 20;

            if (includeTimestamps) {
                doc.setFontSize(12);
                doc.setTextColor(127, 140, 141);
                doc.text(`Export Date: ${new Date().toLocaleString()}`, marginLeft, yPosition);
                yPosition += 15;
            }

            if (includeStats) {
                const totalFiles = savedCodes.reduce((sum, code) => sum + (code.files ? code.files.length : 0), 0);
                const totalImages = savedCodes.reduce((sum, code) => sum + (code.files ? code.files.filter(f => f.type === 'image').length : 0), 0);
                
                doc.setFontSize(11);
                doc.setTextColor(39, 174, 96);
                doc.text(`Total Codes: ${savedCodes.length} | Total Files: ${totalFiles} | Images: ${totalImages}`, marginLeft, yPosition);
                yPosition += 20;
            }

            for (let i = 0; i < savedCodes.length; i++) {
                const code = savedCodes[i];
                
                // Check if we need a new page
                if (yPosition > pageHeight - marginBottom - 100) {
                    doc.addPage();
                    yPosition = 20;
                }

                // Code header
                doc.setFontSize(16);
                doc.setTextColor(52, 152, 219);
                doc.text(`${i + 1}. ${code.title}`, marginLeft, yPosition);
                yPosition += 15;

                if (includeTimestamps) {
                    doc.setFontSize(10);
                    doc.setTextColor(127, 140, 141);
                    doc.text(`Added: ${code.dateAdded} ${code.timeAdded} | Modified: ${code.dateModified} ${code.timeModified}`, marginLeft + 5, yPosition);
                    yPosition += 12;
                }

                // Code content
                doc.setFontSize(10);
                doc.setTextColor(44, 62, 80);
                const codeLines = code.content.split('\n');
                codeLines.forEach(line => {
                    if (yPosition > pageHeight - marginBottom - 20) {
                        doc.addPage();
                        yPosition = 20;
                    }
                    doc.text(line.substring(0, 80), marginLeft + 5, yPosition);
                    yPosition += 6;
                });

                yPosition += 10;

                // Add images if enabled
                if (includeImages && code.files) {
                    const images = code.files.filter(f => f.type === 'image');
                    if (images.length > 0) {
                        doc.setFontSize(12);
                        doc.setTextColor(230, 126, 34);
                        doc.text(`📷 Images (${images.length}):`, marginLeft + 5, yPosition);
                        yPosition += 15;

                        for (let img of images) {
                            if (yPosition > pageHeight - marginBottom - 120) {
                                doc.addPage();
                                yPosition = 20;
                            }

                            try {
                                // Create temporary image to get dimensions
                                const tempImg = new Image();
                                tempImg.src = img.data;
                                
                                // Calculate optimal size maintaining aspect ratio
                                const maxWidth = pageWidth - 60;
                                const maxHeight = 100;
                                
                                let imgWidth = maxWidth;
                                let imgHeight = maxHeight;
                                
                                // Maintain aspect ratio if image loads
                                if (tempImg.naturalWidth && tempImg.naturalHeight) {
                                    const aspectRatio = tempImg.naturalWidth / tempImg.naturalHeight;
                                    if (aspectRatio > 1) {
                                        imgHeight = imgWidth / aspectRatio;
                                        if (imgHeight > maxHeight) {
                                            imgHeight = maxHeight;
                                            imgWidth = imgHeight * aspectRatio;
                                        }
                                    } else {
                                        imgWidth = imgHeight * aspectRatio;
                                        if (imgWidth > maxWidth) {
                                            imgWidth = maxWidth;
                                            imgHeight = imgWidth / aspectRatio;
                                        }
                                    }
                                }
                                
                                // Add image to PDF with improved quality
                                doc.addImage(img.data, 'JPEG', marginLeft + 10, yPosition, imgWidth, imgHeight);
                                yPosition += imgHeight + 8;
                                
                                // Add image name with better formatting
                                doc.setFontSize(10);
                                doc.setTextColor(127, 140, 141);
                                doc.text(`📷 ${img.name} (${formatFileSize(img.size || 0)})`, marginLeft + 10, yPosition);
                                yPosition += 15;
                            } catch (error) {
                                doc.setFontSize(9);
                                doc.setTextColor(231, 76, 60);
                                doc.text(`❌ Image: ${img.name} (Could not embed - ${error.message})`, marginLeft + 10, yPosition);
                                yPosition += 12;
                            }
                        }
                    }
                }

                // Files info (non-images)
                if (code.files) {
                    const docs = code.files.filter(f => f.type === 'file');
                    if (docs.length > 0) {
                        if (yPosition > pageHeight - marginBottom - 30) {
                            doc.addPage();
                            yPosition = 20;
                        }
                        
                        doc.setFontSize(12);
                        doc.setTextColor(230, 126, 34);
                        doc.text(`📁 Attached Files (${docs.length}):`, marginLeft + 5, yPosition);
                        yPosition += 12;

                        docs.forEach(file => {
                            if (yPosition > pageHeight - marginBottom - 10) {
                                doc.addPage();
                                yPosition = 20;
                            }
                            doc.setFontSize(9);
                            doc.setTextColor(127, 140, 141);
                            doc.text(`- ${file.name} (${formatFileSize(file.size || 0)})`, marginLeft + 10, yPosition);
                            yPosition += 6;
                        });
                    }
                }

                yPosition += 20;
            }

            doc.save(`code-keeper-advanced-export-${new Date().toISOString().split('T')[0]}.pdf`);
            alert('📄 Advanced PDF exported successfully with images!');
        }

        function exportToWordWithImages(includeImages, includeStats, includeTimestamps) {
            if (savedCodes.length === 0) {
                alert('No data to export!');
                return;
            }

            let wordContent = `CODE & FILES KEEPER - ADVANCED EXPORT\n`;
            wordContent += `${'='.repeat(60)}\n\n`;
            
            if (includeTimestamps) {
                wordContent += `Export Date: ${new Date().toLocaleString()}\n\n`;
            }
            
            if (includeStats) {
                const totalFiles = savedCodes.reduce((sum, code) => sum + (code.files ? code.files.length : 0), 0);
                const totalImages = savedCodes.reduce((sum, code) => sum + (code.files ? code.files.filter(f => f.type === 'image').length : 0), 0);
                wordContent += `STATISTICS:\n`;
                wordContent += `Total Codes: ${savedCodes.length}\n`;
                wordContent += `Total Files: ${totalFiles}\n`;
                wordContent += `Total Images: ${totalImages}\n\n`;
            }

            savedCodes.forEach((code, index) => {
                wordContent += `${'-'.repeat(60)}\n`;
                wordContent += `${index + 1}. ${code.title.toUpperCase()}\n`;
                wordContent += `${'-'.repeat(60)}\n`;
                
                if (includeTimestamps) {
                    wordContent += `Added: ${code.dateAdded} at ${code.timeAdded}\n`;
                    wordContent += `Modified: ${code.dateModified} at ${code.timeModified}\n\n`;
                }
                
                wordContent += `CODE:\n${code.content}\n\n`;
                
                if (code.files && code.files.length > 0) {
                    if (includeImages) {
                        const images = code.files.filter(f => f.type === 'image');
                        if (images.length > 0) {
                            wordContent += `IMAGES (${images.length}):\n`;
                            images.forEach((img, imgIndex) => {
                                wordContent += `  ${imgIndex + 1}. ${img.name}\n`;
                                wordContent += `     Size: ${formatFileSize(img.size || 0)}\n`;
                                wordContent += `     [IMAGE DATA: ${img.data.substring(0, 100)}...]\n\n`;
                            });
                        }
                    }
                    
                    const docs = code.files.filter(f => f.type === 'file');
                    if (docs.length > 0) {
                        wordContent += `ATTACHED FILES (${docs.length}):\n`;
                        docs.forEach((file, fileIndex) => {
                            wordContent += `  ${fileIndex + 1}. ${file.name}\n`;
                            wordContent += `     Type: ${file.type}\n`;
                            wordContent += `     Size: ${formatFileSize(file.size || 0)}\n`;
                            if (file.mimeType) wordContent += `     MIME: ${file.mimeType}\n`;
                            wordContent += `\n`;
                        });
                    }
                }
                wordContent += `\n`;
            });

            wordContent += `${'-'.repeat(60)}\n`;
            wordContent += `End of Export - Generated by Code & Files Keeper\n`;

            const blob = new Blob([wordContent], { type: 'application/msword' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `code-keeper-advanced-export-${new Date().toISOString().split('T')[0]}.doc`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            alert('📝 Advanced Word document exported successfully with images data!');
        }

        function exportToExcelAdvanced(includeImages, includeStats, includeTimestamps) {
            if (savedCodes.length === 0) {
                alert('No data to export!');
                return;
            }

            const workbook = XLSX.utils.book_new();
            
            // Main data sheet with enhanced info
            const mainData = savedCodes.map((code, index) => {
                const images = code.files ? code.files.filter(f => f.type === 'image') : [];
                const docs = code.files ? code.files.filter(f => f.type === 'file') : [];
                
                let row = {
                    'ID': index + 1,
                    'Title': code.title,
                    'Code Content': code.content,
                    'Files Count': code.files ? code.files.length : 0,
                    'Images Count': images.length,
                    'Documents Count': docs.length,
                    'Total Size (Bytes)': code.files ? code.files.reduce((sum, f) => sum + (f.size || 0), 0) : 0
                };

                if (includeTimestamps) {
                    row['Date Added'] = code.dateAdded;
                    row['Time Added'] = code.timeAdded;
                    row['Date Modified'] = code.dateModified;
                    row['Time Modified'] = code.timeModified;
                }

                if (includeImages && images.length > 0) {
                    row['Image Names'] = images.map(img => img.name).join(', ');
                    row['Image Data Summary'] = `${images.length} images included`;
                }

                return row;
            });

            const mainSheet = XLSX.utils.json_to_sheet(mainData);
            XLSX.utils.book_append_sheet(workbook, mainSheet, 'Codes');

            // Images sheet with full data
            if (includeImages) {
                const imagesData = [];
                savedCodes.forEach((code, codeIndex) => {
                    if (code.files) {
                        const images = code.files.filter(f => f.type === 'image');
                        images.forEach((img, imgIndex) => {
                            imagesData.push({
                                'Code ID': codeIndex + 1,
                                'Code Title': code.title,
                                'Image Index': imgIndex + 1,
                                'Image Name': img.name,
                                'Image Size (Bytes)': img.size || 0,
                                'Image Size': formatFileSize(img.size || 0),
                                'MIME Type': img.mimeType || 'image/*',
                                'Image Data (Base64)': img.data
                            });
                        });
                    }
                });

                if (imagesData.length > 0) {
                    const imagesSheet = XLSX.utils.json_to_sheet(imagesData);
                    XLSX.utils.book_append_sheet(workbook, imagesSheet, 'Images Data');
                }
            }

            // Files sheet
            const filesData = [];
            savedCodes.forEach((code, codeIndex) => {
                if (code.files && code.files.length > 0) {
                    code.files.forEach((file, fileIndex) => {
                        filesData.push({
                            'Code ID': codeIndex + 1,
                            'Code Title': code.title,
                            'File Index': fileIndex + 1,
                            'File Name': file.name,
                            'File Type': file.type,
                            'File Size (Bytes)': file.size || 0,
                            'File Size': formatFileSize(file.size || 0),
                            'MIME Type': file.mimeType || 'unknown',
                            'Is Image': file.type === 'image' ? 'Yes' : 'No'
                        });
                    });
                }
            });

            if (filesData.length > 0) {
                const filesSheet = XLSX.utils.json_to_sheet(filesData);
                XLSX.utils.book_append_sheet(workbook, filesSheet, 'All Files');
            }

            // Statistics sheet
            if (includeStats) {
                const totalFiles = savedCodes.reduce((sum, code) => sum + (code.files ? code.files.length : 0), 0);
                const totalImages = savedCodes.reduce((sum, code) => sum + (code.files ? code.files.filter(f => f.type === 'image').length : 0), 0);
                const totalDocs = savedCodes.reduce((sum, code) => sum + (code.files ? code.files.filter(f => f.type === 'file').length : 0), 0);
                const totalSize = savedCodes.reduce((sum, code) => sum + (code.files ? code.files.reduce((s, f) => s + (f.size || 0), 0) : 0), 0);

                const statsData = [{
                    'Metric': 'Total Codes',
                    'Value': savedCodes.length
                }, {
                    'Metric': 'Total Files',
                    'Value': totalFiles
                }, {
                    'Metric': 'Total Images',
                    'Value': totalImages
                }, {
                    'Metric': 'Total Documents',
                    'Value': totalDocs
                }, {
                    'Metric': 'Total Size (Bytes)',
                    'Value': totalSize
                }, {
                    'Metric': 'Total Size (Formatted)',
                    'Value': formatFileSize(totalSize)
                }];

                if (includeTimestamps) {
                    statsData.push({
                        'Metric': 'Export Date',
                        'Value': new Date().toLocaleDateString()
                    }, {
                        'Metric': 'Export Time',
                        'Value': new Date().toLocaleTimeString()
                    });
                }

                const statsSheet = XLSX.utils.json_to_sheet(statsData);
                XLSX.utils.book_append_sheet(workbook, statsSheet, 'Statistics');
            }

            XLSX.writeFile(workbook, `code-keeper-advanced-export-${new Date().toISOString().split('T')[0]}.xlsx`);
            alert('📊 Advanced Excel file exported successfully with images data!');
        }

        function importData(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const importedCodes = JSON.parse(e.target.result);
                    if (confirm(`Import ${importedCodes.length} codes? This will replace your current data.`)) {
                        savedCodes = importedCodes;
                        localStorage.setItem('savedCodes', JSON.stringify(savedCodes));
                        displayCodes();
                        updateStats();
                        alert('✅ Data imported successfully!');
                    }
                } catch (error) {
                    alert('❌ Error reading file. Make sure it\'s a valid backup file.');
                }
            };
            reader.readAsText(file);
            
            // Reset file input
            event.target.value = '';
        }

        // Close modal when clicking outside
        window.onclick = function(event) {
            const imageModal = document.getElementById('imageModal');
            const detailModal = document.getElementById('detailModal');
            
            if (event.target == imageModal) {
                imageModal.style.display = 'none';
            }
            if (event.target == detailModal) {
                detailModal.style.display = 'none';
            }
        }

        // Enhanced image modal function for detail view
        function showImageModal(imageSrc) {
            document.getElementById('modalImage').src = imageSrc;
            document.getElementById('imageModal').style.display = 'block';
        }

        // Multiple codes functionality
        function toggleContentMode() {
            const mode = document.querySelector('input[name="contentMode"]:checked').value;
            const singleForm = document.getElementById('singleCodeForm');
            const multipleForm = document.getElementById('multipleCodesForm');
            
            if (mode === 'single') {
                singleForm.style.display = 'block';
                multipleForm.style.display = 'none';
            } else {
                singleForm.style.display = 'none';
                multipleForm.style.display = 'block';
            }
        }

        let multipleSelectedFiles = [];

        function setupMultipleFileHandling() {
            const multipleFileInput = document.getElementById('multipleFileInput');
            if (multipleFileInput) {
                multipleFileInput.addEventListener('change', function(e) {
                    handleMultipleFileSelection(e.target.files);
                });
            }
        }

        function handleMultipleFileSelection(files) {
            Array.from(files).forEach(file => {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const fileType = file.type.startsWith('image/') ? 'image' : 'file';
                    multipleSelectedFiles.push({
                        name: file.name,
                        data: e.target.result,
                        type: fileType,
                        size: file.size,
                        mimeType: file.type
                    });
                    displayMultipleFilePreview();
                };
                
                if (file.type.startsWith('image/')) {
                    reader.readAsDataURL(file);
                } else {
                    reader.readAsDataURL(file);
                }
            });
        }

        function displayMultipleFilePreview() {
            const preview = document.getElementById('multipleFilePreview');
            preview.innerHTML = '';

            multipleSelectedFiles.forEach((file, index) => {
                const fileDiv = displayFilePreview(file, index, true);
                preview.appendChild(fileDiv);
            });
        }

        function removeMultipleFile(index) {
            multipleSelectedFiles.splice(index, 1);
            displayMultipleFilePreview();
        }

        function previewMultipleCodes() {
            const content = document.getElementById('multipleContent').value.trim();
            if (!content) {
                alert('الرجاء إدخال الأكواد أولاً');
                return;
            }

            const separator = getSeparator();
            const codes = content.split(separator).filter(code => code.trim());
            
            const preview = document.getElementById('multiplePreview');
            preview.innerHTML = '';
            
            if (codes.length === 0) {
                preview.innerHTML = '<p style="color: #e74c3c; text-align: center;">لم يتم العثور على أكواد للمعاينة</p>';
                preview.style.display = 'block';
                return;
            }

            codes.forEach((code, index) => {
                const codeLines = code.trim().split('\n');
                const title = codeLines[0] || `كود ${index + 1}`;
                const content = codeLines.slice(1).join('\n').trim();

                const previewItem = document.createElement('div');
                previewItem.className = 'preview-item';
                previewItem.innerHTML = `
                    <div class="preview-title">${index + 1}. ${title}</div>
                    <div class="preview-content">${content}</div>
                `;
                preview.appendChild(previewItem);
            });

            preview.style.display = 'block';
            
            // Show files count if any
            if (multipleSelectedFiles.length > 0) {
                const filesInfo = document.createElement('div');
                filesInfo.innerHTML = `<p><strong>الملفات المشتركة:</strong> ${multipleSelectedFiles.length} ملف سيتم إرفاقه مع كل كود</p>`;
                filesInfo.style.background = '#e8f5e8';
                filesInfo.style.padding = '10px';
                filesInfo.style.borderRadius = '5px';
                filesInfo.style.marginTop = '10px';
                preview.appendChild(filesInfo);
            }
        }

        function getSeparator() {
            const separatorType = document.querySelector('input[name="separator"]:checked').value;
            if (separatorType === 'custom') {
                const customSep = document.getElementById('customSeparator').value.trim();
                return customSep || '---';
            }
            return separatorType;
        }

        function addMultipleCodes() {
            const content = document.getElementById('multipleContent').value.trim();
            if (!content) {
                alert('الرجاء إدخال الأكواد أولاً');
                return;
            }

            const separator = getSeparator();
            const codes = content.split(separator).filter(code => code.trim());
            
            if (codes.length === 0) {
                alert('لم يتم العثور على أكواد صالحة');
                return;
            }

            let successCount = 0;
            const now = new Date();

            codes.forEach((code, index) => {
                const codeLines = code.trim().split('\n');
                const title = codeLines[0] || `كود ${index + 1}`;
                const codeContent = codeLines.slice(1).join('\n').trim();

                if (codeContent) {
                    const newCode = {
                        id: Date.now() + index,
                        title: title,
                        content: codeContent,
                        files: [...multipleSelectedFiles], // Copy shared files to each code
                        dateAdded: now.toLocaleDateString('en-US'),
                        timeAdded: now.toLocaleTimeString('en-US'),
                        dateModified: now.toLocaleDateString('en-US'),
                        timeModified: now.toLocaleTimeString('en-US')
                    };

                    savedCodes.push(newCode);
                    successCount++;
                }
            });

            if (successCount > 0) {
                localStorage.setItem('savedCodes', JSON.stringify(savedCodes));
                
                // Reset form
                document.getElementById('multipleContent').value = '';
                multipleSelectedFiles = [];
                displayMultipleFilePreview();
                document.getElementById('multiplePreview').style.display = 'none';
                
                displayCodes();
                updateStats();
                alert(`✅ تم حفظ ${successCount} كود بنجاح!`);
            } else {
                alert('❌ لم يتم حفظ أي كود. تأكد من صحة التنسيق.');
            }
        }
    </script>
    <!-- PWA Service Worker Registration -->
    <script>
        // Service Worker Registration
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', function() {
                navigator.serviceWorker.register('/sw.js')
                    .then(function(registration) {
                        console.log('ServiceWorker registration successful');
                    })
                    .catch(function(err) {
                        console.log('ServiceWorker registration failed: ', err);
                    });
            });
        }

        // PWA Install Prompt
        let deferredPrompt;
        const installButton = document.createElement('button');
        installButton.textContent = '📱 تثبيت التطبيق';
        installButton.style.cssText = 
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: #4CAF50;
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 25px;
            font-size: 14px;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            z-index: 1000;
            display: none;
            font-family: inherit;
        ;

        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            installButton.style.display = 'block';
            document.body.appendChild(installButton);
        });

        installButton.addEventListener('click', async () => {
            if (deferredPrompt) {
                deferredPrompt.prompt();
                const { outcome } = await deferredPrompt.userChoice;
                console.log(User response to the install prompt: +outcome);
                deferredPrompt = null;
                installButton.style.display = 'none';
            }
        });

        // Hide install button after installation
        window.addEventListener('appinstalled', () => {
            installButton.style.display = 'none';
            console.log('PWA was installed');
        });

        // Check if app is installed
        if (window.matchMedia('(display-mode: standalone)').matches) {
            console.log('App is running in standalone mode');
        }
    </script>
</body>
</html>



